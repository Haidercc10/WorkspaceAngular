<app-menuLateral></app-menuLateral>
<br>

<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">

    <div class="mb-4 Titulo">
      <h2 class="tituloRojo">Pedidos de Asesores Comerciales</h2>
    </div>

    <div class="mb-4">
      <hr class="colorLinea">
    </div>

    <!-- Tabla de Pedidos -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
      <button pButton pRipple label="Exportar Excel" icon="pi pi-file-excel" class="p-button-success r-2" (click)="exportarExcel()"></button>
    </div>

    <div class="mb-4">
      <h3 class="tituloRojo">Información de Pedidos</h3>
    </div>

    <div *ngIf="!load" id="tableProcesos" class="font-size-14">
      <div class="mb-4 ">
        <div class="row g-3">
          <p-treeTable #tt
            [value]="ArrayDocumento"
            [resizableColumns]="true"
            columnResizeMode="expand"
            styleClass="p-treetable-sm p-treetable-gridlines"
            [paginator]="true"
            [rows]="ArrayDocumento.length"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros"
            [rowsPerPageOptions]="[10,20,30,50,70,100, ArrayDocumento.length]"
            [rowHover]="true"
            [scrollable]="true"
            scrollHeight="1000px">
            <ng-template pTemplate="colgroup">
               <colgroup>
                 <col style="width:120px">
                 <col style="width:200px">
                 <col style="width:200px">
                 <col style="width:140px">
                 <col style="width:100px">
                 <col style="width:80px">
                 <col style="width:100px">
                 <col style="width:100px">
                 <col style="width:180px">
                 <col style="width:120px">
                 <col style="width:160px">
                 <col style="width:150px">
                 <col style="width:60px">
                 <col style="width:80px">
                 <col style="width:80px" *ngIf="ValidarRol == 1">
                 <col style="width:80px" *ngIf="ValidarRol == 1">
               </colgroup>
            </ng-template>
            <ng-template pTemplate="header">
              <tr>
                <th ttResizableColumn style="width: 150px">
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')">
                </th>
                <th ttResizableColumn style="width: 200px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'cliente', 'contains')">
                </th>
                <th ttResizableColumn style="width: 200px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'producto', 'contains')">
                </th>
                <th ttResizableColumn style="width: 150px">
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'cant_Pedida', 'contains')">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'existencias', 'contains')">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'presentacion', 'contains')">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'precio', 'contains')">
                </th>
                <th ttResizableColumn style="width: 200px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'estado', 'contains')">
                </th>
                <th ttResizableColumn style="width: 200px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'vendedor', 'contains')">
                </th>
                <th ttResizableColumn style="width: 150px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'costo_Cant_Total', 'contains')">
                </th>
                <th ttResizableColumn style="width: 150px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'fechaCreacion', 'contains')">
                </th>
                <th ttResizableColumn style="width: 150px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'fechaEntrega', 'contains')">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')" *ngIf="ValidarRol == 1">
                </th>
                <th ttResizableColumn style="width: 100px">
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')" *ngIf="ValidarRol == 1">
                </th>
              </tr>
              <tr>
                <th style="text-align: center; width: max-content;" class="font-size-14" ttSortableColumn="consecutivo">Pedido
                  <p-treeTableSortIcon field="consecutivo"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="cliente">Cliente
                  <p-treeTableSortIcon field="cliente"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="producto">Producto
                  <p-treeTableSortIcon field="producto"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="cant_Pedida">Cant. Pedida
                  <p-treeTableSortIcon field="cant_Pedida"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="existencias">Stock
                  <p-treeTableSortIcon field="existencias"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="presentacion">Und
                  <p-treeTableSortIcon field="presentacion"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="precio">Precio
                  <p-treeTableSortIcon field="precio"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="estado">Estado
                  <p-treeTableSortIcon field="estado"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="vendedor">Vendedor
                  <p-treeTableSortIcon field="vendedor"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="costo_Cant_Total">Total
                  <p-treeTableSortIcon field="costo_Cant_Total"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="fechaCreacion">Fecha Creación
                  <p-treeTableSortIcon field="fechaCreacion"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="fechaCreacion">Fecha Entrega
                  <p-treeTableSortIcon field="fechaCreacion"></p-treeTableSortIcon>
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="consecutivo">Ver PDF
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="consecutivo">Editar
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="consecutivo" *ngIf="ValidarRol == 1">Confirmar
                </th>
                <th style="text-align: center;" class="font-size-14" ttSortableColumn="consecutivo" *ngIf="ValidarRol == 1">Cancelar
                </th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rowNode let-data="rowData">
              <ng-container *ngIf="data.Zeus == 1; then EnZeus; else NoZeus"></ng-container>
              <ng-template #EnZeus>
                <ng-container *ngIf="data.ExistenciaMayor; then thenTemplate; else elseTemplate">></ng-container>
                <ng-template #thenTemplate>
                  <ng-container *ngIf="data.Cant_Items_ExistenciaMayor < data.Cant_Items; then azul; else verde"></ng-container>
                  <ng-template #azul>
                    <tr style="text-align: center; background-color: #ABEBC6;">
                      <td style="text-align: center;" scope="col" title="N° Pedido">
                        <p-treeTableToggler [rowNode]="rowNode" ></p-treeTableToggler>
                        {{data.consecutivo}}
                      </td>
                      <td scope="col" title="Cliente">{{data.cliente}}</td>
                      <td scope="col" title="Item">{{data.producto}}</td>
                      <td style="text-align: center;" scope="col" title="Cantidad Pedida">{{data.cant_Pedida | number : '1.2-2'}}</td>
                      <td style="text-align: center;" scope="col" title="Existencias">{{data.existencias | number : '1.2-2'}}</td>
                      <td style="text-align: center;" scope="col" title="Presentación">{{data.presentacion}}</td>
                      <td style="text-align: center;" scope="col" title="Presentación">{{data.precio}}</td>
                      <td style="text-align: center;" scope="col" title="Estado del Pedido">{{data.estado}}</td>
                      <td scope="col" title="Vendedor">{{data.vendedor}}</td>
                      <td style="text-align: center;" scope="col" title="Subtotal">{{data.costo_Cant_Total | number}}</td>
                      <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaCreacion}}</td>
                      <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaEntrega}}</td>
                      <td style="text-align: center;" scope="col"><button (click)="mostrarPedidoPdf(data)" pButton pRipple icon="pi pi-file-pdf" class="p-button-rounded p-button-warning mr-2" style="width: 30px; height: 30px;"></button></td>
                      <td style="text-align: center;" scope="col"></td>
                      <td style="text-align: center;" scope="col" *ngIf="ValidarRol == 1"></td>
                      <td style="text-align: center;" scope="col" *ngIf="ValidarRol == 1"></td>
                    </tr>
                  </ng-template>
                  <ng-template #verde>
                    <tr style="text-align: center; background-color: #ABEBC6;">
                      <td style="text-align: center;" scope="col" title="N° Pedido">
                        <p-treeTableToggler [rowNode]="rowNode" ></p-treeTableToggler>
                        {{data.consecutivo}}
                      </td>
                      <td scope="col" title="Cliente">{{data.cliente}}</td>
                      <td scope="col" title="Item">{{data.producto}}</td>
                      <td style="text-align: center;" scope="col" title="Cantidad Pedida">{{data.cant_Pedida | number : '1.2-2'}}</td>
                      <td style="text-align: center;" scope="col" title="Existencias">{{data.existencias | number : '1.2-2'}}</td>
                      <td style="text-align: center;" scope="col" title="Presentación">{{data.presentacion}}</td>
                      <td style="text-align: center;" scope="col" title="Presentación">{{data.precio}}</td>
                      <td style="text-align: center;" scope="col" title="Estado del Pedido">{{data.estado}}</td>
                      <td scope="col" title="Vendedor">{{data.vendedor}}</td>
                      <td style="text-align: center;" scope="col" title="Subtotal">{{data.costo_Cant_Total | number}}</td>
                      <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaCreacion}}</td>
                      <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaEntrega}}</td>
                      <td style="text-align: center;" scope="col" title="Confirmar Pedido"><button (click)="mostrarPedidoPdf(data)" pButton pRipple icon="pi pi-file-pdf" class="p-button-rounded p-button-warning mr-2" style="width: 30px; height: 30px;"></button></td>
                      <td style="text-align: center;" scope="col" title="Editar Pedido"></td>
                      <td style="text-align: center;" scope="col" *ngIf="ValidarRol == 1"></td>
                      <td style="text-align: center;" scope="col" *ngIf="ValidarRol == 1"></td>
                    </tr>
                  </ng-template>
                </ng-template>
                <ng-template #elseTemplate>
                  <tr>
                    <td style="text-align: center;" scope="col" title="N° Pedido">
                      <p-treeTableToggler [rowNode]="rowNode" ></p-treeTableToggler>
                      {{data.consecutivo}}
                    </td>
                    <td scope="col" title="Cliente">{{data.cliente}}</td>
                    <td scope="col" title="Item">{{data.producto}}</td>
                    <td style="text-align: center;" scope="col" title="Cantidad Pedida">{{data.cant_Pedida | number : '1.2-2'}}</td>
                    <td style="text-align: center;" scope="col" title="Existencias">{{data.existencias | number : '1.2-2'}}</td>
                    <td style="text-align: center;" scope="col" title="Presentación">{{data.presentacion}}</td>
                    <td style="text-align: center;" scope="col" title="Presentación">{{data.precio}}</td>
                    <td style="text-align: center;" scope="col" title="Estado del Pedido">{{data.estado}}</td>
                    <td scope="col" title="Vendedor">{{data.vendedor}}</td>
                    <td style="text-align: center;" scope="col" title="Subtotal">{{data.costo_Cant_Total | number}}</td>
                    <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaCreacion}}</td>
                    <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaEntrega}}</td>
                    <td style="text-align: center;" scope="col"><button (click)="mostrarPedidoPdf(data)" pButton pRipple icon="pi pi-file-pdf" class="p-button-rounded p-button-warning mr-2" style="width: 30px; height: 30px;"></button></td>
                    <td style="text-align: center;" scope="col" title="Editar Pedido"></td>
                    <td style="text-align: center;" scope="col" *ngIf="ValidarRol == 1"></td>
                    <td style="text-align: center;" scope="col" *ngIf="ValidarRol == 1"></td>
                  </tr>
                </ng-template>
              </ng-template>
              <ng-template #NoZeus>
                <tr style="text-align: center; background-color: #FAACAC;">
                  <td style="text-align: center;" scope="col" title="N° Pedido">
                    <p-treeTableToggler [rowNode]="rowNode" ></p-treeTableToggler>
                    {{data.consecutivo}}
                  </td>
                  <td scope="col" title="Cliente">{{data.cliente}}</td>
                  <td scope="col" title="Item">{{data.producto}}</td>
                  <td style="text-align: center;" scope="col" title="Cantidad Pedida">{{data.cant_Pedida | number : '1.2-2'}}</td>
                  <td style="text-align: center;" scope="col" title="Existencias">{{data.existencias | number : '1.2-2'}}</td>
                  <td style="text-align: center;" scope="col" title="Presentación">{{data.presentacion}}</td>
                  <td style="text-align: center;" scope="col" title="Presentación">{{data.precio}}</td>
                  <td style="text-align: center;" scope="col" title="Estado del Pedido">{{data.estado}}</td>
                  <td scope="col" title="Vendedor">{{data.vendedor}}</td>
                  <td style="text-align: center;" scope="col" title="Subtotal">{{data.costo_Cant_Total | number}}</td>
                  <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaCreacion}}</td>
                  <td style="text-align: center;" scope="col" title="Fecha Creación">{{data.fechaEntrega}}</td>
                  <td style="text-align: center;" scope="col" title="Confirmar Pedido"><button (click)="productosPedido(data.consecutivo)" pButton pRipple icon="pi pi-file-pdf" class="p-button-rounded p-button-warning mr-2" style="width: 30px; height: 30px;"></button></td>
                  <td style="text-align: center;" scope="col" title="Editar Pedido"><button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-info mr-2" data-bs-toggle="modal" data-bs-target="#staticBackdrop2" (click)="editarPedido(data)" style="width: 30px; height: 30px;"></button></td>
                  <td style="text-align: center;" scope="col" title="Confirmar Pedido" *ngIf="ValidarRol == 1"><button (click)="confirmarActualizacion(data.consecutivo)" pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-success mr-2" style="width: 30px; height: 30px;"></button></td>
                  <td style="text-align: center;" scope="col" title="Confirmar Pedido" *ngIf="ValidarRol == 1"><button (click)="confirmarCancelacion(data.consecutivo)" pButton pRipple icon="pi pi-times" class="p-button-rounded p-button-danger mr-2" style="width: 30px; height: 30px;"></button></td>
                </tr>
              </ng-template>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr>
                <td colspan="9" class="text-right">Totales</td>
                <td colspan="6">{{precioTotalPedidos | currency : 'COP $'}}</td>
              </tr>
            </ng-template>
          </p-treeTable>
        </div>
      </div>
    </div>

    <div class="modal fade" id="staticBackdrop2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel2">Editar Pedido</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="cargarPedidosPendientes()"></button>
          </div>
          <div class="modal-body">
            <app-Pedido-Externo></app-Pedido-Externo>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
