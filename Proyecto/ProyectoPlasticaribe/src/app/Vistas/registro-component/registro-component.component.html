<app-menuLateral></app-menuLateral>

<div class="d-flex justify-content-center overlay" *ngIf="!load">
  <div class="spinner-border text-danger" role="status" style="margin: auto;">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 class="tituloRojo">Gestión de Usuarios</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<div class="contain">
  <div class="container-fluid bajarPagina">
    <div class="container">

      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button pButton pRipple label="Nuevo Rol" icon="pi pi-plus" class="p-button-success r-2" (click)="modalRoles_TiposUsuarios()"></button>
        <button pButton pRipple label="Nueva Area" icon="pi pi-plus" (click)="modalAreas()" class="p-button-success"></button>
      </div>

      <div class="mb-4">
        <h4 class="tituloRojo">Tabla de Usuarios</h4>
      </div>

      <div class="card" *ngIf="load">
        <p-toolbar styleClass="mb-4 gap-2">
          <ng-template pTemplate="left">
            <button pButton pRipple label="Nuevo" icon="pi pi-plus" class="p-button-success r-2" style="margin-right: 3%;" (click)="cargarModalUsuarios()"></button>
            <button pButton pRipple label="Eliminar" icon="pi pi-trash" *ngIf="usuariosInactivar.length > 0; else inactivo" (click)="advertenciaInactivarVariosUsuarios()" class="p-button-danger"></button>
            <ng-template #inactivo>
              <button pButton pRipple label="Eliminar" icon="pi pi-trash" [disabled]="true" class="p-button-danger"></button>
            </ng-template>
          </ng-template>

          <ng-template pTemplate="right">
            <button pButton pRipple label="Exportar" icon="pi pi-upload" title="Exportar Excel" class="p-button-success" (click)="exportarExcel()"></button>
          </ng-template>
        </p-toolbar>
        <!--Inicio Tabla-->
        <p-table
          #dt
          [value]="arrayUsuarios"
          [resizableColumns]="true"
          columnResizeMode="expand"
          styleClass="p-datatable-gridlines p-datatable-sm"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="rows"
          [showCurrentPageReport]="true"
          [(first)]="first"
          [rowsPerPageOptions]="[10,20,30,50,70,100]"
          [rowHover]="true"
          [globalFilterFields]="['Id','Nombre','Area']"
          [(selection)]="usuariosInactivar"
          currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros" >
          <ng-template pTemplate="caption">
            <div class="flex align-items-center justify-content-between">
              <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input pInputText type="text" placeholder="Buscar Usuarios..." (input)="aplicarfiltroGlobal($event, 'contains')"/>
              </span>
            </div>
          </ng-template>
          <!--Headers Tabla-->
          <ng-template pTemplate="header">
            <tr >
              <th style="width: 4rem"><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
              <th scope="col" pSortableColumn="Id">ID Usuario <p-sortIcon field="Id"></p-sortIcon></th>
              <th scope="col" pSortableColumn="Nombre">Nombre <p-sortIcon field="Nombre"></p-sortIcon></th>
              <th scope="col" pSortableColumn="Tipo">Tipo <p-sortIcon field="Tipo"></p-sortIcon></th>
              <th scope="col" pSortableColumn="Area">Área <p-sortIcon field="Area"></p-sortIcon></th>
              <th scope="col" pSortableColumn="Rol">Rol <p-sortIcon field="Rol"></p-sortIcon></th>
              <th scope="col" pSortableColumn="Estado">Estado <p-sortIcon field="Estado"></p-sortIcon></th>
              <th scope="col">Editar</th>
              <th scope="col">Eliminar</th>
            </tr>
          </ng-template>
          <!--Cuerpo Tabla-->
          <ng-template pTemplate="body" let-arrayUsuarios>
            <tr>
              <td><p-tableCheckbox [value]="arrayUsuarios"></p-tableCheckbox></td>
              <td>{{arrayUsuarios.Id}}</td>
              <td>{{arrayUsuarios.Nombre}}</td>
              <td>{{arrayUsuarios.Tipo}}</td>
              <td>{{arrayUsuarios.Area}}</td>
              <td>{{arrayUsuarios.Rol}}</td>
              <td *ngIf="arrayUsuarios.Estado == 'Activo'; else Inactivo">{{arrayUsuarios.Estado}}</td>
              <ng-template #Inactivo><td><span class="badge bg-danger1">{{arrayUsuarios.Estado}}</span></td></ng-template>
              <td style="text-align: center;"><button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2" (click)="cargarModalEditarUsuario(arrayUsuarios)" style="width: 30px; height: 30px;"></button></td>
              <td style="text-align: center;"><button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="advertenciaInactivarUsuario(arrayUsuarios)" style="width: 30px; height: 30px;"></button></td>
            </tr>
          </ng-template>
          <ng-template pTemplate="summary">
            <div class="flex align-items-center justify-content-between">
              En total hay {{cantidadUsuarios}} usuarios.
            </div>
          </ng-template>
        </p-table>
      </div>
      <p-dialog [(visible)]="dialogUsuarios" [style]="{width: '450px'}" header="{{accion}} Usuarios" [modal]="true" styleClass="p-fluid">
        <ng-template pTemplate="content">
          <form [formGroup]="FormUsuarios">

            <!-- ID -->
            <div class="form-floating col-md mb-3" *ngIf="accion == 'Crear'; else Editar">
              <input formControlName="usuId" type="number" class="form-control form-control-sm" id="floatingInput" autocomplete="off" >
              <label for="floatingInput">ID Usuario</label>
            </div>

            <ng-template #Editar>
              <div class="form-floating col-md mb-3">
                <input formControlName="usuId" type="number" class="form-control form-control-sm" id="floatingInput" autocomplete="off" readonly onmousedown="return false">
                <label for="floatingInput">ID Usuario</label>
              </div>
            </ng-template>

            <!-- Nombre -->
            <div class="form-floating col-md mb-3">
              <input formControlName="usuNombre" type="text" class="form-control form-control-sm" id="floatingInput" autocomplete="off">
              <label for="floatingInput">Nombre Usuario</label>
            </div>

            <div class="mb-3">
              <div class="row g-3">
                 <!-- Tipo de Usuario -->
                <div class="form-floating col-md">
                  <select formControlName="usuTipo" id="floatingSelect" class="form-select form-select-sm" aria-label=".form-select-sm example" autocomplete="off">
                    <option [ngValue]="item.tpUsu_Id" *ngFor="let item of arrayTiposUsuarios">{{item.tpUsu_Nombre}}</option>
                  </select>
                  <label for="floatingSelect">Tipo Usuario</label>
                </div>

                  <!-- Area -->
                <div class="form-floating col-md">
                  <select formControlName="usuArea" id="floatingSelect" class="form-select form-select-sm" aria-label=".form-select-sm example" autocomplete="off">
                    <option [ngValue]="item.area_Id" *ngFor="let item of arrayAreas">{{item.area_Nombre}}</option>
                  </select>
                  <label for="floatingSelect">Área</label>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <div class="row g-3">
                <!-- Rol -->
                <div class="form-floating col-md">
                  <select formControlName="usuRol" id="floatingSelect" class="form-select form-select-sm" aria-label=".form-select-sm example" autocomplete="off">
                    <option [ngValue]="item.rolUsu_Id" *ngFor="let item of arrayRoles">{{item.rolUsu_Nombre}}</option>
                  </select>
                  <label for="floatingSelect">Rol Usuario</label>
                </div>
                <!-- Estado -->
                <div class="form-floating col-md">
                  <select formControlName="usuEstado" id="floatingSelect" class="form-select form-select-sm" aria-label=".form-select-sm example" autocomplete="off">
                    <option [ngValue]="item.estado_Id" *ngFor="let item of arrayEstados">{{item.estado_Nombre}}</option>
                  </select>
                  <label for="floatingSelect">Estado</label>
                </div>
              </div>
            </div>
            <!-- PassWord -->
            <div class="input-group col-md mb-3">
              <input formControlName="usuPassword" type="password" class="form-control form-control-sm" aria-describedby="button-addon2" id="pass" autocomplete="off">

              <ng-container *ngIf="mostrarPass; then noMostrar else mostrar"></ng-container>
              <ng-template #mostrar>
                <button class="btn btn-outline-secondary" type="button" id="button-addon2" (click)="mostrarPassword()"><i class="pi pi-eye"></i></button>
              </ng-template>

              <ng-template #noMostrar>
                <button class="btn btn-outline-secondary" type="button" id="button-addon2" (click)="mostrarPassword()"><i class="pi pi-eye-slash"></i></button>
              </ng-template>
            </div>

            <!--Boton Ingresar al sistema-->
            <div class="mb-3">
              <button pButton pRipple label="{{accion}} Usuario" (click)="accionesModal()" class="p-button-success"></button>
            </div>
          </form>
        </ng-template>
      </p-dialog>


      <p-dialog [(visible)]="nuevoDialogo" [style]="{width: '450px'}" header="Crear {{accionDialogoNuevo}}" [modal]="true" styleClass="p-fluid">
        <ng-container *ngIf="accionDialogoNuevo == 'Rol' then rol; else area"></ng-container>
        <p-toast position="center"></p-toast>
        <!-- FORMULARIO ROLES -->
        <ng-template #rol>
          <form [formGroup]="formRoles">
            <!-- Nombre -->
            <div class="form-floating col-md mb-3">
              <input formControlName="rolNombre" class="form-control form-control-sm" list="roles" id="floatingInput" required (keyup)="cargarRoles_Like()">
              <datalist id="roles">
                <option value={{item.rolUsu_Nombre}} *ngFor="let item of arrayRoles">{{item.rolUsu_Nombre}}</option>
              </datalist>
              <label for="floatingInput">Nombre</label>
            </div>

            <!-- Descripcion -->
            <div class="form-floating col-md mb-3">
              <textarea formControlName="rolDescripcion" style="height: 80px;"  type="text" class="form-control form-control-sm" id="floatingInput" autocomplete="off"></textarea>
              <label for="floatingInput">Descripción</label>
            </div>
          </form>
        </ng-template>

        <!-- FORMULARIO AREAS -->
        <ng-template #area>
          <form [formGroup]="formAreas">
            <!-- Nombre -->
            <div class="form-floating col-md mb-3">
              <input formControlName="areaNombre" class="form-control form-control-sm" list="areas" id="floatingInput" required (keyup)="cargarAreas_Like()">
              <datalist id="areas">
                <option value={{item.area_Nombre}} *ngFor="let item of arrayAreas">{{item.area_Nombre}}</option>
              </datalist>
              <label for="floatingInput">Nombre</label>
            </div>

            <!-- Descripcion -->
            <div class="form-floating col-md mb-3">
              <textarea formControlName="areaDescripcion" style="height: 80px;" type="text" class="form-control form-control-sm" id="floatingInput" autocomplete="off"></textarea>
              <label for="floatingInput">Descripción</label>
            </div>
          </form>
        </ng-template>

         <!--Boton agregar Rol/Area-->
         <div class="mb-3">
          <button pButton pRipple label="Agregar {{accionDialogoNuevo}}" icon="pi pi-plus" (click)="agregar()" class="p-button-success"></button>
        </div>
      </p-dialog>
    </div>
  </div>
</div>

