<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Devolución de Facturación</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-book"></i> Datos de la Factura.</h4>
  </div>

  <form [formGroup]="formDataOrder">
    <div class="row g-4">
      <!-- Fact -->
      <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <input formControlName="fact" id="Factura" type="text" pInputText required (keyup.enter)="searchData()"/>
          <label for="Factura">Factura</label>
        </span>
      </div>

      <!-- Id Client -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <input formControlName="idClient" id="idClient" type="text" pInputText required readonly/>
          <label for="idClient">Id Cliente</label>
        </span>
      </div>

      <!-- Client -->
      <div class="col-xs-12 col-sm-12 col-md-7 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="client" id="Cliente" type="text" pInputText required readonly/>
          <label for="Cliente">Cliente</label>
        </span>
      </div>

      <!-- Item -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="item" id="IdProducto" type="text" pInputText required [readOnly]="true"/>
          <label for="IdProducto">Item</label>
        </span>
      </div>

      <!-- Reference -->
      <div class="col-xs-12 col-sm-12 col-md-9 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="reference" id="reference" type="text" pInputText required readonly/>
          <label for="reference">Referencia</label>
        </span>
      </div>

      <!-- Observacion -->
      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
        <span class="p-float-label">
          <textarea formControlName="observation" [rows]="1" maxlength="200" pInputTextarea></textarea>
          <label for="textarea">Observación</label>
        </span>
      </div>
    </div>
  </form>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Rollos Disponibles.</h4>
  </div>

  <p-table
    [value]="production"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    dataKey="numberProduction"
    [(selection)]="productionSelected"
    *ngIf="!load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-tableCheckbox [value]="data" (click)="selectedProduction(data)"></p-tableCheckbox>
        </td>
        <td>{{data.numberProduction}}</td>
        <td>{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td>{{data.quantity | number : '1.2-2'}}</td>
        <td>{{data.presentation}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="4">Total</td>
        <td colspan="2"></td>
      </tr>
    </ng-template>
  </p-table>
  
  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Rollos Seleccionados.</h4>
  </div>

  <p-table
    [value]="productionSelected"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    [(selection)]="production"
    dataKey="numberProduction"
    *ngIf="!load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="deselectedAllProduction()"></p-checkbox>
        </th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-tableCheckbox [value]="data" (click)="deselectedProduction(data)"></p-tableCheckbox>
        </td>
        <td>{{data.numberProduction}}</td>
        <td>{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td>{{data.quantity | number : '1.2-2'}}</td>
        <td>{{data.presentation}}</td>
      </tr>
    </ng-template>
  </p-table>
  
  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Consolidado de Productos Elegidos</h4>
  </div>

  <p-table
    [value]="consolidatedProduction"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    dataKey="item">
    <ng-template pTemplate="header">
      <tr>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Cantidad Rollos</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td>{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td>{{totalQuantityByProduct(data.item) | number : '1.2-2'}}</td>
        <td>{{totalCountProductionByProduct(data.item) | number : '1.2-2'}}</td>
        <td>{{data.presentation}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="3">Total</td>
        <td colspan="2">{{productionSelected.length | number : '1.2-2'}}</td>
      </tr>
    </ng-template>
  </p-table>

  <p-divider></p-divider>

  <div class="d-grid gap-2 d-md-flex justify-content-md-center">
    <button pButton class="p-button-danger" type="button" label="Crear Devolución" icon="pi pi-send" (click)="validateInformation()"></button>
    <button pButton class="p-button-secondary" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearFields()"></button>
  </div>

</p-card>