<div class="d-flex justify-content-center overlay" *ngIf="load">
    <div style="margin: auto;">
      <p-progressSpinner></p-progressSpinner>
    </div>
  </div>

  <div class="contain">
    <div class="container-fluid">
      <div class="mb-4 Titulo">
        <h2 [ngClass]="{'tituloRojo' : !selectedMode, 'tituloClaro': selectedMode }">Movimientos de Peletizado</h2>
      </div>
  
      <div class="mb-4">
        <hr class="colorLinea">
      </div>
    </div>
  </div>
  
  <p-card>
    <!--* Titulo formulario-->
    <div class="mb-4">
      <h2 [ngClass]="{'tituloRojo' : !selectedMode, 'tituloClaro': selectedMode }"><i class="pi pi-filter"></i> Filtros de Búsqueda</h2>
    </div>

    <!--* Formulario de busqueda-->
    <form [formGroup]="form" (ngSubmit)="searchInPeletizado()">
      <div class="row g-4 my-4">

        <!--RANGO DE FECHAS-->
        <div class="col-sm-12 col-md-6 col-xl-3">
            <span class="p-float-label">
              <p-calendar formControlName="rankDates" inputId="fecha" selectionMode="range" [showIcon]="true"></p-calendar>
              <label for="fecha">Rango de Fechas</label>
            </span>
        </div>  
    
        <!-- OT -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-2 col-xl-2 col-xxl-2">
            <span class="p-float-label">
            <p-inputNumber formControlName="orderProduction" [useGrouping]="false" inputId="orderProduction" [required]="true"></p-inputNumber>
            <label for="orderProduction">OT</label>
            </span>
        </div>
    
        <!-- MP -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3">
          <span class="p-float-label">
            <input formControlName="mpName" id="Nombre" list="mp" type="text" pInputText (change)="changeMaterial()"/>
            <datalist id="mp">
              <option value={{item.id_Materia_Prima}} *ngFor="let item of materiasPrimas">{{item.nombre_Materia_Prima}}</option>
            </datalist>
            <label for="Orden">Materia Prima</label>
          </span>
        </div>
    
        <!-- STATUS -->
        <div class="col-sm-12 col-md-6 col-xl-2">
          <span class="p-float-label">
            <p-dropdown formControlName="status" inputId="status" [autoDisplayFirst]="false" [options]="statuses" optionValue="estado_Id" optionLabel="estado_Nombre"></p-dropdown>
            <label for="status">Estado</label>
          </span>
       </div>

        <!-- TYPE MOV. -->
        <div class="col-sm-12 col-md-6 col-xl-2">
           <span class="p-float-label">
             <p-dropdown formControlName="typeMov" inputId="typeMov" [autoDisplayFirst]="false" [options]="typesMovements"></p-dropdown>
             <label for="typeMov">Tipo Movimiento</label>
           </span>
        </div>

        <!--BUTTONS-->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <button pButton class="p-button-danger" type="submit" label="Consultar" icon="pi pi-search"></button>
            <button pButton class="p-button-secondary" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearFields()"></button>
        </div>
      </div>
    </form>

    <p-divider></p-divider>

    <!--* Titulo tabla-->
    <div class="mb-4">
      <h2 [ngClass]="{'tituloRojo' : !selectedMode, 'tituloClaro': selectedMode }"><i class="pi pi-table"></i> Tabla de registros consultados</h2>
    </div>

      <!--* ENTRADAS -->
      <div class="row g-4">
        <div class="col-sm-12 col-md-7 px-5"> 

          <p-toolbar styleClass="mb-2">
            <ng-template pTemplate="left">
            </ng-template>
            <ng-template pTemplate="center">
              <h2><b class="mr-2" [ngClass]="{'tituloRojo' : !selectedMode, 'tituloClaro': selectedMode }"><i class="pi pi-cloud-download"></i> Entradas a bodega de Peletizado</b></h2>
            </ng-template>
            <ng-template pTemplate="right">
            </ng-template>
          </p-toolbar>

          <p-table 
            #tableData1
            [value]="entries"
            [resizableColumns]="true"
            styleClass="p-datatable-gridlines p-datatable-sm"
            responsiveLayout="scroll"
            [rowHover]="true"
            [scrollable]="true"
            scrollHeight="50rem"
            *ngIf="!load">
            <ng-template pTemplate="header">
              <tr class="font-size-16" id="filtros">
                <th></th>
                <th></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.id', tableData1)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.recovery_Id', tableData1)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.initialQty', tableData1)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'matPrimas.id', tableData1)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'matPrimas.matPrima', tableData1)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'data.status', tableData1)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.date', tableData1)"></th>
              </tr>
              <tr>
                <th style="font-weight: 800;" class="text-center" colspan="2"></th>
                <th style="font-weight: 800;" class="text-center" colspan="3"><i class="pi pi-slack"></i> Información Recuperado</th>
                <th style="font-weight: 800;" class="text-center" colspan="2"><i class="pi pi-box"></i> Mat. Prima asociada</th>
                <th style="font-weight: 800;" class="text-center" colspan="4"></th>
              </tr>
              <tr>
                <th class="text-center">#</th>
                <th>Ver</th>
                <th class="text-center" pSortableColumn="mov.id"><p-sortIcon field="mov.id"></p-sortIcon> Id</th>
                <th class="text-center" pSortableColumn="mov.recovery_Id"><p-sortIcon field="mov.recovery_Id"></p-sortIcon> Nombre</th>
                <th class="text-center" pSortableColumn="mov.initialQty"><p-sortIcon field="mov.initialQty"></p-sortIcon> Peso (Kg)</th>
                <th class="text-center" pSortableColumn="mov.id"><p-sortIcon field="mov.id"></p-sortIcon> Id </th> 
                <th class="text-center" pSortableColumn="mov.matPrima"><p-sortIcon field="mov.matPrima"></p-sortIcon> Nombre</th>
                <th class="text-center" pSortableColumn="mov.status"><p-sortIcon field="mov.status"></p-sortIcon> Estado</th>
                <th class="text-center" pSortableColumn="mov.date"><p-sortIcon field="mov.date"></p-sortIcon> Fecha</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
              <tr>
                <td class="text-center">{{rowIndex + 1}}</td>
                <td class="text-center">
                  <p-button icon="pi pi-file-pdf" [rounded]="true" severity="danger" (onClick)="viewPDF(data)"></p-button>
                </td>
                <td class="text-center">{{ data.mov.id }}</td> 
                <td class="text-center">{{ data.mov.recovery_Id }}</td>
                <td class="text-center"><b>{{ data.mov.initialQty | number : '1.2-2' }}</b></td>  
                <td class="text-center">{{ data.matPrimas.id }}</td> 
                <td><b>{{ data.matPrimas.matPrima }}</b></td> 
                <td class="text-center"><span class="badge" [ngClass]="{'bg-danger1': [23].includes(data.mov.status_Id), 
                                                                        'bg-danger2': [11].includes(data.mov.status_Id), 
                                                                        'bg-success1': [19].includes(data.mov.status_Id), 
                                                                        'bg-warning1': [42].includes(data.mov.status_Id), }"
                                                                        >{{ data.status }}</span></td>
                <td class="text-center">{{ data.mov.date | date : 'dd/MM/yyyy' }}</td> 
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr>
                <td colspan="4" class="text-right">Cantidad Total</td>
                <td class="text-center">{{totalQty(entries) | number : '1.2-2'}}</td>
                <td colspan="4"></td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <!--* SALIDAS-->
        <div class="col-sm-12 col-md-5 px-5"> 

          <p-toolbar styleClass="mb-2">
            <ng-template pTemplate="left">
            </ng-template>
            <ng-template pTemplate="center">
              <b class="mr-2" [ngClass]="{'tituloRojo' : !selectedMode, 'tituloClaro': selectedMode }"><i class="pi pi-cloud-upload"></i> Salidas de bodega de Peletizado</b>
            </ng-template>
            <ng-template pTemplate="right">
            </ng-template>
          </p-toolbar>

          <p-table 
            #tableData2
            [value]="outputs"
            [resizableColumns]="true"
            styleClass="p-datatable-gridlines p-datatable-sm"
            responsiveLayout="scroll"
            [rowHover]="true"
            [scrollable]="true"
            scrollHeight="50rem"
            *ngIf="!load">
            <ng-template pTemplate="header">
              <tr class="font-size-16" id="filtros">
                <th colspan="2"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'matPrimas.id', tableData2)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'matPrimas.matPrima', tableData2)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, '', tableData2)"></th>
                <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'data.status', tableData2)"></th>
              </tr>
              <tr>
                <th style="font-weight: 800;" class="text-center" colspan="2"></th>
                <th style="font-weight: 800;" class="text-center" colspan="3"><i class="pi pi-box"></i> Mat. Prima Recuperada</th>
                <th style="font-weight: 800;" class="text-center"></th>
              </tr>
              <tr>
                <th class="text-center">#</th>
                <th>Ver</th>
                <th class="text-center" pSortableColumn="matPrimas.id"><p-sortIcon field="matPrimas.id"></p-sortIcon> Id</th> 
                <th class="text-center" pSortableColumn="matPrimas.matPrima"><p-sortIcon field="matPrimas.matPrima"></p-sortIcon> Nombre</th>
                <th class="text-center" pSortableColumn="mov.qty"><p-sortIcon field="mov.qty"></p-sortIcon> Peso (Kg)</th>
                <th class="text-center" pSortableColumn="mov.date"><p-sortIcon field="mov.date"></p-sortIcon> Estado</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
              <tr [ngClass]="{'cursor' : [11].includes(data.mov.status_Id), }" (dblclick)="loadModalRecovery(data)" >
                <td class="text-center">{{rowIndex + 1}}</td>
                <td class="text-center">
                  <p-button icon="pi pi-eye" [rounded]="true" severity="danger" (click)="viewModalDetailsOutputs(data.matPrimas.id, data.status)"></p-button>
                </td>
                <td class="text-center">{{ data.matPrimas.id }}</td> 
                <td>{{ data.matPrimas.matPrima }}</td> 
                <td class="text-center"><b>{{ groupQtyOutputs(data.matPrimas.id, data.status) | number : '1.2-2' }}</b></td> 
                <td class="text-center"><span class="badge" [ngClass]="{'bg-danger1': [23].includes(data.mov.status_Id), 
                                                                        'bg-danger2': [11].includes(data.mov.status_Id), 
                                                                        'bg-success1': [19].includes(data.mov.status_Id), 
                                                                        'bg-blue1': [26].includes(data.mov.status_Id) }"
                                                                        >{{ data.status }}</span> </td> <!--Estado-->
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr>
                <td colspan="4" class="text-right">Cantidad Total</td>
                <td class="text-center">{{totalQty(hiddenOutputs) | number : '1.2-2'}}</td>
                <td colspan="2"></td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>  
    
  </p-card>  

  <p-dialog header="Recuperado de Materia Prima" [(visible)]="modal" [modal]="true" [style]="{ width: '90vw' }" [draggable]="false" [resizable]="false">
    <app_MateriaPrimaRecuperada></app_MateriaPrimaRecuperada>
  </p-dialog>

  <p-dialog header="Detalle de salidas de bodega de peletizado" [(visible)]="modalOutputs" [modal]="true" [style]="{ width: '70vw' }" [draggable]="false" [resizable]="false">
    <p-table 
      #tableData3
      [value]="detailsOutputs"
      [resizableColumns]="true"
      styleClass="p-datatable-gridlines p-datatable-sm"
      responsiveLayout="scroll"
      [rowHover]="true"
      [scrollable]="true"
      scrollHeight="50rem"
      *ngIf="!load">
      <ng-template pTemplate="header">
        <tr class="font-size-16" id="filtros">
          <th></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.code', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'matPrimas.id', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'matPrimas.matPrima', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.qty', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.date', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.nameUser', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'mov.nameUser2', tableData3)"></th>
          <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'data.status', tableData3)"></th>
        </tr>
        <tr>
          <th class="text-center">#</th>
          <th class="text-center" pSortableColumn="mov.code"><p-sortIcon field="mov.code"></p-sortIcon> Código Mov.</th> 
          <th class="text-center" pSortableColumn="matPrimas.id"><p-sortIcon field="matPrimas.id"></p-sortIcon> Id</th> 
          <th class="text-center" pSortableColumn="matPrimas.matPrima"><p-sortIcon field="matPrimas.matPrima"></p-sortIcon> Nombre</th>
          <th class="text-center" pSortableColumn="mov.qty"><p-sortIcon field="mov.qty"></p-sortIcon> Peso (Kg)</th>
          <th class="text-center" pSortableColumn="mov.date"><p-sortIcon field="mov.date"></p-sortIcon> Estado</th>
          <th class="text-center" pSortableColumn="mov.date"><p-sortIcon field="mov.date"></p-sortIcon> Usuario Crea</th>
          <th class="text-center" pSortableColumn="mov.date"><p-sortIcon field="mov.date"></p-sortIcon> Usuario Aprueba</th>
          <th class="text-center" pSortableColumn="mov.status"><p-sortIcon field="mov.status"></p-sortIcon> Fecha Crea</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
        <tr>
          <td class="text-center">{{rowIndex + 1}}</td>
          <td class="text-center">{{ data.mov.code }}</td>
          <td class="text-center">{{ data.matPrimas.id }}</td> 
          <td>{{ data.matPrimas.matPrima }}</td> 
          <td class="text-center"><b>{{ data.mov.qty | number : '1.2-2' }}</b></td> 
          <td class="text-center"><span class="badge" [ngClass]="{'bg-danger1': [23].includes(data.mov.status_Id), 
                                                                  'bg-danger2': [11].includes(data.mov.status_Id), 
                                                                  'bg-success1': [19].includes(data.mov.status_Id), 
                                                                  'bg-blue1': [26].includes(data.mov.status_Id) }"
                                                                  >{{ data.status }}</span> </td> <!--Estado-->
          <td class="text-center">{{ data.nameUser }}</td>
          <td class="text-center">{{ data.nameUser2 }}</td>                                                          
          <td class="text-center">{{ data.mov.date | date : 'dd/MM/yyyy' }}</td> 
        </tr>
      </ng-template>
      <ng-template pTemplate="footer">
        <tr>
          <td colspan="5" class="text-right">Cantidad Total</td>
          <td class="text-center">{{totalQty(detailsOutputs) | number : '1.2-2'}}</td>
          <td colspan="4"></td>
        </tr>
      </ng-template>
    </p-table>
  </p-dialog>
  