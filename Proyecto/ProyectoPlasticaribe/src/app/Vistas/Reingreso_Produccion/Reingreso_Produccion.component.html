<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<!--Entrada opcional-->
<div class="mb-5" id="opcional" *ngIf="ValidarRol == 1">
  <p-accordion [activeIndex]="0"> 
    <p-accordionTab header="Asociar rollos/bultos enviados a reempaque/peletizado en devoluciones gestionadas">
      
      <div class="mb-5">
        <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-wrench"></i> Cargar datos de devolución</h4>
      </div>

      <!--Formulario-->
      <form [formGroup]="form">
        <div class="row g-4 mb-3">

          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-1 col-xxl-1">
            <span class="p-float-label">
              <input formControlName="dev" id="dev" type="text" (keyup.enter)="searchDevolutions()" pInputText required/>
              <label for="dev">Devolución</label>
            </span>
          </div>

          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
            <span class="p-float-label">
              <p-dropdown formControlName="reason" inputId="reason" [readonly]="true" [autoDisplayFirst]="false" [options]="fails" optionLabel="falla_Nombre" optionValue="falla_Id" [filter]="true" filterBy="falla_Nombre"></p-dropdown>
              <label for="reason">Motivo*</label>
            </span>
          </div>

          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-1 col-xxl-1">
            <div class="field-checkbox">
              <p-checkbox formControlName="creditNote" [binary]="true" [readonly]="true" inputId="creditNote" id="creditNote" pTooltip="Al checar este elemento indicas que la devolución se realizó con una nota crédito."></p-checkbox>
              <label for="creditNote">Nota Crédito</label>
            </div>
          </div>

          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
            <span class="p-float-label">
              <input formControlName="fact" id="fact" type="text" pInputText required readonly/>
              <label for="fact">Factura</label>
            </span>
          </div>

          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
            <span class="p-float-label">
              <input formControlName="idClient" id="idClient" type="text" pInputText required readonly/>
              <label for="idClient">Id Cliente</label>
            </span>
          </div>

          <div class="col-xs-12 col-sm-12 col-md-6 col-lg-3 col-xl-3 col-xxl-3">
            <span class="p-float-label">
              <input formControlName="client" id="Cliente" type="text" pInputText required readonly/>
              <label for="Cliente">Cliente</label>
            </span>
          </div>

          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-1 col-xl-1 col-xxl-1">
            <div class="field-checkbox">
              <p-checkbox formControlName="adjustment" [binary]="true" [readonly]="true" inputId="adjustment" id="adjustment" pTooltip="Al checar este elemento podrás indicar si el rollo/bulto seleccionado tendrá ajuste positivo en zeus o no."></p-checkbox>
              <label for="adjustment">Ajuste Zeus</label>
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <button pButton class="p-button-danger" type="button" label="Consultar" icon="pi pi-search" (click)="searchDevolutions()"></button>
            <button pButton class="p-button-secondary" type="button" label="Limpiar Todo" icon="pi pi-eraser" (click)="clearFieldsDevolutions()"></button>
          </div>

        </div>
      </form>

      <p-divider></p-divider>

      <!--Titulo Tabla-->
      <div class="mb-3">
        <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-wrench"></i> Tabla de bultos/rollos</h4>
      </div>

      <!--Tabla-->
      <p-table 
        [value]="rolls" 
        selectionMode="single" 
        [(selection)]="selectedRolls" 
        [metaKeySelection]="metaKey"
        dataKey="numberProduction"
        [scrollable]="true" 
        scrollHeight="400px"
        styleClass="p-datatable-sm" 
        >
        <ng-template pTemplate="header">
          <tr>
            <th>N°</th>
            <th>Rollo/Bulto</th>
            <th>OT</th>
            <th>Item</th>
            <th>Referencia</th>
            <th>Cantidad</th>
            <th>Presentacion</th>
            <th>Estado</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
          <tr [pSelectableRow]="data" [pSelectableRowIndex]="rowIndex">
            <td>{{ rowIndex + 1 }}</td>
            <td>{{data.numberProduction}}</td>
            <td>{{data.ot}}</td>
            <td>{{data.item}}</td>
            <td>{{data.reference}}</td>
            <td>{{data.quantity | number : '1.2-2'}}</td>
            <td>{{data.presentation}}</td>
            <td><span class="badge" [ngClass]="{'bg-danger1': ['PELETIZADO'].includes(data.statusName), 'bg-success1': ['DISPONIBLE'].includes(data.statusName), 'bg-warning1': ['REEMPAQUE'].includes(data.statusName)}">{{data.statusName}}</span></td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="5"></td>
            <td>{{totalQty() | number : '1.2-2'}}</td>
            <td colspan="2"></td>  
          </tr>
        </ng-template>
      </p-table>

    </p-accordionTab>
  </p-accordion>
</div>

<div class="my-2">
  <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-wrench"></i> Cargar Datos Producción</h4>
</div>

<div class="row my-5 g-4 justify-content-center">
  <div class="col-sm-12 col-md-2">
    <span class="p-float-label">
      <input type="text" id="RolloBarsCode" pInputText autocomplete="off" pAutoFocus [autofocus]="true" [disabled]="!form.valid && rolls.length == 0 && selectedRolls.length == 0 || form.valid && rolls.length > 0 && selectedRolls.length == 0" [(ngModel)]="productionSearched" (keyup.enter)="validateUbicationSelected()"/>
      <label for="Rollo">Rollo Leído</label>
    </span>
  </div>

  <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-3 col-xxl-2">
    <span class="p-float-label">
      <p-dropdown [(ngModel)]="storehouseSelected" id="bodegas" optionValue="id" [autoDisplayFirst]="false" [options]="storehouse" optionLabel="nombre" (onChange)="getUbicationByStorehouse()" ></p-dropdown>
      <label for="bodegas">Bodega</label>
    </span>
  </div>

  <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-3 col-xxl-2">
    <span class="p-float-label">
      <p-dropdown [(ngModel)]="ubicationSelected" id="ubication" optionValue="nombreCompleto" [autoDisplayFirst]="false" [options]="ubicationsStorehouse" optionLabel="nombreCompleto" (onChange)="getSubUbicationByStorehouse()"></p-dropdown>
      <label for="ubication">Ubicación</label>
    </span>
  </div>

  <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-3 col-xxl-2">
    <span class="p-float-label">
      <p-dropdown [(ngModel)]="subUbicationSelected" id="subUbication" optionValue="idSubUbicacion" [autoDisplayFirst]="false" [options]="subUbicationsStorehouse" optionLabel="nombreCompleto" (onChange)="getCubesBySubUbication()"></p-dropdown>
      <label for="subUbication">Sub Ubicación</label>
    </span>
  </div>

  <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-3 col-xxl-2">
    <span class="p-float-label">
      <p-dropdown [(ngModel)]="cubeSelected" id="cube" optionValue="idCubo" [autoDisplayFirst]="false" [options]="cubes" optionLabel="idCubo"></p-dropdown>
      <label for="cube">Cubos</label>
    </span>
  </div>

  <div class="col-sm-12 col-md-6 col-xl-2" id="iva">
    <div class="field-checkbox my-2 mx-4">
      <p-triStateCheckbox [(ngModel)]="searchIn" inputId="tricheckbox"></p-triStateCheckbox>
      <label for="tricheckbox">
        <p-chip [label]="searchIn == null ? 'Todos' : searchIn ? 'Extrusión/Empaque' : 'Sellado'"
                [icon]="searchIn == null ? 'pi pi-sync' : searchIn ? 'pi pi-bolt' : 'pi pi-box'"></p-chip>
      </label>
    </div>
  </div>
</div>

<div class="d-grid gap-2 d-md-flex justify-content-md-center my-2">
  <button pButton class="p-button-danger m-2" type="button" label="Exportar PDF" icon="pi pi-file-pdf" [disabled]="sendProductionZeus.length == 0"></button>
  <button pButton class="p-button-secondary m-2" id="limpiar" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearFields()"></button>
</div>

<p-table
[value]="sendProductionZeus"
columnResizeMode="expand"
styleClass="p-datatable-sm"
responsiveLayout="scroll"
[rowHover]="true"
[showCurrentPageReport]="true"
currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} rollos"
[scrollable]="true"
scrollHeight="50rem">
  <ng-template pTemplate="header">
    <tr>
      <th class="text-center">#</th>
      <th class="text-center">OT</th>
      <th class="text-center">Cliente</th>
      <th class="text-center">Rollo</th>
      <th class="text-center">Item</th>
      <th class="text-center">Referencia</th>
      <th class="text-center">Peso Bruto</th>
      <th class="text-center">Peso Neto</th>
      <th class="text-center">Presentación</th>
      <th class="text-center">Material</th>
      <th class="text-center">Maquina</th>
      <th class="text-center">Fecha</th>
      <th class="text-center">Hora</th>
      <th class="text-center">Turno</th>
      <th class="text-center">Proceso</th>
      <!-- <th class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">Imprimir</th> -->
      <th class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">Quitar</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
    <tr>
      <td class="text-center">{{data.position}}</td>
      <td class="text-center">{{data.pp.ot}}</td>
      <td class="text-center">{{data.clientes.cli_Nombre}}</td>
      <td class="text-center">{{data.dataExtrusion.numero_RolloBagPro}}</td>
      <td class="text-center">{{data.producto.prod_Id}}</td>
      <td class="text-center">{{data.producto.prod_Nombre}}</td>
      <td class="text-center">{{(['Und', 'Paquete'].includes(data.pp.presentacion) ? data.pp.cantidad : data.pp.peso_Bruto) | number : '1.2-2'}}</td>
      <td class="text-center">{{data.pp.peso_Neto | number : '1.2-2'}}</td>
      <td class="text-center">{{data.pp.presentacion}}</td>
      <td class="text-center">{{data.dataExtrusion.material}}</td>
      <td class="text-center">{{data.pp.maquina}}</td>
      <td class="text-center">{{data.pp.fecha | date : 'YYYY-MM-dd'}}</td>
      <td class="text-center">{{data.pp.hora}}</td>
      <td class="text-center">{{data.turno.turno_Nombre}}</td>
      <td class="text-center">{{data.proceso.proceso_Nombre | uppercase}}</td>
      <!-- <td class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">
        <p-button icon="pi pi-print" [rounded]="true" severity="success" (onClick)="printTag(data)"></p-button>
      </td> -->
      <td class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">
        <p-button icon="pi pi-trash" [rounded]="true" severity="danger" (onClick)="removeProduction(data)"></p-button>
      </td>
    </tr>
  </ng-template>
</p-table>

