<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain" *ngIf="!reposition">
  <div class="container-fluid">
    <div class="mb-5 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Orden de Facturación</h2>
    </div>

    <div class="mb-5">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="my-5">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-book"></i> Datos de la orden.</h4>
  </div>

  <form [formGroup]="formDataOrder">
    <div class="row g-4">

      <!--Type Document-->
      <!--<div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <p-dropdown formControlName="typeDoc"  (onChange)="validateTypeDoc()" inputId="typeDoc" [autoDisplayFirst]="true" [options]="typesDoc" optionLabel="tpDoc_Nombre" optionValue="tpDoc_Id"></p-dropdown>
          <label for="typeDoc">Tipo Documento</label>
        </span>
      </div>-->

      <!-- Order -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 col-xxl-2">
        <span class="p-float-label">
          <input formControlName="order" id="order" type="number" [readonly]="reposition || ![null, '', 0, undefined].includes(formDataOrder.value.preload)" pInputText (keyup.enter)="getInfoOrderFact()"/>
          <label for="order">N° Orden</label>
        </span>
      </div>

      <!-- Sale Order -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 col-xxl-2">
        <span class="p-input-icon-left p-float-label"><!--[readonly]="formDataOrder.value.typeDoc == 'REPO' ? true : false"-->
          <i class="pi pi-search"></i>
          <input formControlName="saleOrder" id="saleOrder" type="text" [readonly]="editOrderFact || reposition" pInputText (keyup.enter)="getSalesOrders()"/>
          <label for="saleOrder">N° Pedido</label>
        </span>
      </div>

      <!-- Preload Dispatch -->
      <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="preload" id="preload" type="text" type="number" [readonly]="editOrderFact || reposition" (keyup.enter)="getPreloadForId()" pInputText/>
          <label for="preload">N° Precargue</label>
        </span>
      </div> 

      <!-- Id Client -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <input formControlName="idClient" id="idClient" type="text" pInputText required readonly/>
          <label for="idClient">Id Cliente</label>
        </span>
      </div>

      <!-- Client -->
      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-4">
        <span class="p-float-label"><!--formDataOrder.value.typeDoc == 'REPO' ? false : true-->
          <input formControlName="client" id="Cliente" list="clientes" type="text" autocomplete="off" pInputText required readonly (keyup)="getClients()" (change)="selectedClient()"/>
          <datalist id="clientes">
            <option value={{item.cli_Id}} *ngFor="let item of clients">{{item.cli_Nombre}}</option>
          </datalist>
          <label for="Cliente">Cliente</label>
        </span>
      </div>

      <!-- Item -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="item" id="IdProducto" type="text" pInputText required (keyup.enter)="searchProductByItem()"/>
          <label for="IdProducto">Item</label>
        </span>
      </div> -->

      <!-- Reference -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-9 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="reference" id="reference" list="products" type="text" autocomplete="off" pInputText required (keyup)="getProducts()" (change)="selectedProduct()"/>
          <datalist id="products">
            <option value={{item.prod.prod_Id}} *ngFor="let item of products">{{item.prod.prod_Nombre}}</option>
          </datalist>
          <label for="reference">Referencia</label>
        </span>
      </div> -->

      <!-- Observacion -->
      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
        <span class="p-float-label">
          <textarea formControlName="observation" [rows]="1" [readonly]="reposition" maxlength="200" pInputTextarea></textarea>
          <label for="textarea">Observación</label>
        </span>
      </div>
    </div>
  </form>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Productos del Pedido.</h4>
  </div>

  <!--Productos del pedido-->
  <p-toolbar styleClass="mb-4 gap-2" *ngIf="reposition || editOrderFact">
    <ng-template pTemplate="left">
        <button pButton pRipple label="Agregar Item" icon="pi pi-plus" class="p-button-danger mr-2" (click)="modalAddItems = true"></button>
    </ng-template>

    <ng-template pTemplate="right">
    </ng-template>
  </p-toolbar>

  <p-table
    [value]="products"
    selectionMode="single"
    [(selection)]="selectedProductSaleOrder"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    dataKey="id_Producto"
    (onRowSelect)="this.getProducts()"
    (onRowUnselect)="this.getProducts()">
    <ng-template pTemplate="header">
      <tr>
        <th class="text-center">Pedido</th>
        <th class="text-center">Nit</th>
        <th class="text-center">Cliente</th>
        <th class="text-center">Item</th>
        <th class="text-center">Referencia</th>
        <th class="text-center">Cantidad</th>
        <th class="text-center">Presentación</th>
        <th *ngIf="editOrderFact"></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr [pSelectableRow]="data">
        <td class="text-center">{{data.consecutivo}}</td>
        <td class="text-center">{{data.id_Cliente}}</td>
        <td>{{data.cliente}}</td>
        <td class="text-center">{{data.id_Producto}}</td>
        <td>{{data.producto}}</td>
        <td class="text-center"><b>{{data.cant_Pendiente | number : '1.2-2'}}</b></td>
        <td class="text-center">{{data.presentacion}}</td>
        <th class="text-center" *ngIf="editOrderFact">
          <p-button icon="pi pi-trash" [rounded]="true" severity="danger" (onClick)="seeMsjDeleteItem(data)" pTooltip="Eliminar item {{data.id_Producto}} - {{data.producto}} de la orden." tooltipPosition="top"></p-button>
        </th>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Consolidado de Productos Elegidos</h4>
  </div>

  <!--Consolidado-->
  <p-table
    [value]="consolidatedProduction"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    dataKey="item">
    <ng-template pTemplate="header">
      <tr>
        <th class="text-center">#</th>
        <th class="text-center">Pedido</th>
        <th class="text-center">Item</th>
        <th class="text-center">Referencia</th>
        <th class="text-center">Peso Bruto</th>
        <th class="text-center">Peso Neto</th>
        <th class="text-center">Cantidad</th>
        <th class="text-center">Cantidad Rollos</th>
        <th class="text-center">Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td class="text-center">{{rowIndex + 1}}</td>
        <td class="text-center">{{data.saleOrder}}</td>
        <td class="text-center">{{data.item}}</td>
        <td class="text-center">{{data.reference}}</td>
        <td class="text-center">{{totalWeightByProduct(data.item) | number : '1.2-2'}}</td>
        <td class="text-center">{{totalNetWeightByProduct(data.item) | number : '1.2-2'}}</td>
        <td class="text-center"><b>{{totalQuantityByProduct(data.item) | number : '1.2-2'}}</b></td>
        <td class="text-center">{{totalCountProductionByProduct(data.item)}}</td>
        <td class="text-center">{{data.presentation}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td class="text-right" colspan="4"></td>
        <td class="text-center">{{totalTotalWeightProducts() | number : '1.2-2'}}</td>
        <td class="text-center">{{totalTotalNetWeightProducts() | number : '1.2-2'}}</td>
        <td class="text-center">{{totalTotalProducts() | number : '1.2-2'}}</td>
        <td class="text-center">{{productionSelected.length}}</td>
        <td></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Rollos Disponibles.</h4>
  </div>

  <!--Rollos disponibles-->
  <p-table
    #tableProduction
    [value]="production"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    dataKey="numberProduction"
    [(selection)]="productionSelected"
    *ngIf="!load"
    [rowHover]="true">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>#</th>
        <th class="text-center" pSortableColumn="numberProduction">
          <p-sortIcon field="numberProduction"></p-sortIcon> Rollo
          <p-columnFilter type="text" field="numberProduction" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="orderProduction">
          <p-sortIcon field="orderProduction"></p-sortIcon> OT
          <p-columnFilter type="text" field="orderProduction" display="menu"></p-columnFilter>
        </th>
        <!--<th class="text-center" pSortableColumn="client">
          <p-sortIcon field="client"></p-sortIcon> Nit
          <p-columnFilter type="text" field="client" display="menu"></p-columnFilter>
        </th>-->
        <th class="text-center" pSortableColumn="nameClient">
          <p-sortIcon field="nameClient"></p-sortIcon> Cliente
          <p-columnFilter type="text" field="nameClient" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="item">
          <p-sortIcon field="item"></p-sortIcon> Item
          <p-columnFilter type="text" field="item" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="reference">
          <p-sortIcon field="reference"></p-sortIcon> Referencia
          <p-columnFilter type="text" field="reference" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="quantity">
          <p-sortIcon field="quantity"></p-sortIcon> Cant.
          <p-columnFilter type="text" field="quantity" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="presentation">
          <p-sortIcon field="presentation"></p-sortIcon> Und
          <p-columnFilter type="text" field="presentation" display="menu"></p-columnFilter>
        </th>
        <!--Nuevo-->
        <th class="text-center" pSortableColumn="weight">
          <p-sortIcon field="weight"></p-sortIcon> P. Bruto
          <p-columnFilter type="text" field="weight" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="netWeight">
          <p-sortIcon field="netWeight"></p-sortIcon> P. Neto
          <p-columnFilter type="text" field="netWeight" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="ubication">
          <p-sortIcon field="ubication"></p-sortIcon> Ubicación
          <p-columnFilter type="text" field="ubication" display="menu"></p-columnFilter>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-tableCheckbox [value]="data" (click)="selectedProduction(data)"></p-tableCheckbox>
        </td>
        <td class="text-center">{{rowIndex + 1}}</td>
        <td class="text-center">{{data.numberProduction}}</td>
        <td class="text-center">{{data.orderProduction}}</td>
        <!--<td class="text-center">{{data.client}}</td>-->
        <td class="text-center">{{data.nameClient}}</td>
        <td class="text-center">{{data.item}}</td>
        <td class="text-center">{{data.reference}}</td>
        <td class="text-center textBlue"><b>{{data.quantity | number : '1.2-2'}}</b></td>
        <td class="text-center">{{data.presentation}}</td>
        <!--Nuevo-->
        <td class="text-center">{{data.weight | number : '1.2-2'}}</td>
        <td class="text-center">{{data.netWeight | number : '1.2-2'}}</td>
        <td class="text-center">{{data.ubication}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="2">Seleccionar: </td>
        <td class="text-center"><p-button icon="pi pi-check-circle" [rounded]="true" severity="success" (onClick)="selectByFilters()" pTooltip="Seleccionar todo o seleccionar por la información filtrada"></p-button></td>
        <td><p-inputNumber [(ngModel)]="qtyToSend" mode="decimal" [minFractionDigits]="2" [maxFractionDigits]="2" class="length"> </p-inputNumber></td>
        <td class="text-center"><p-button icon="pi pi-search-plus" [rounded]="true" severity="warning" (onClick)="selectByQuantity()" pTooltip="Seleccionar por cantidad"></p-button></td>
        <td class="text-right" colspan="2">Total</td>
        <!--Nuevo-->
        <td class="text-center">{{totalProduccionSearched() | number : '1.2-2'}}</td>
        <td colspan="4"></td>
      </tr>
    </ng-template>
  </p-table>

  <p-table
    [value]="production"
    *ngIf="load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Rollos Seleccionados.</h4>
  </div>

  <!--Rollos seleccionados-->
  <p-table
    #tableProductionSelected
    [value]="productionSelected"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    [(selection)]="production"
    dataKey="numberProduction"
    *ngIf="!load"
    [rowHover]="true">
    <ng-template pTemplate="header">
      <tr>
        <th *ngIf="!editOrderFact && !preloadDispatch" style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="deselectedAllProduction()"></p-checkbox>
        </th>
        <th *ngIf="editOrderFact" style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left"></th>
        <th>#</th>
        <th class="text-center" pSortableColumn="numberProduction">
          <p-sortIcon field="numberProduction"></p-sortIcon> Rollo
          <p-columnFilter type="text" field="numberProduction" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="orderProduction">
          <p-sortIcon field="orderProduction"></p-sortIcon> OT
          <p-columnFilter type="text" field="orderProduction" display="menu"></p-columnFilter>
        </th>
        <!--<th class="text-center" pSortableColumn="client">
          <p-sortIcon field="client"></p-sortIcon> Nit
          <p-columnFilter type="text" field="client" display="menu"></p-columnFilter>
        </th>-->
        <th class="text-center" pSortableColumn="nameClient">
          <p-sortIcon field="nameClient"></p-sortIcon> Cliente
          <p-columnFilter type="text" field="nameClient" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="item">
          <p-sortIcon field="item"></p-sortIcon> Item
          <p-columnFilter type="text" field="item" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="reference">
          <p-sortIcon field="reference"></p-sortIcon> Referencia
          <p-columnFilter type="text" field="reference" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="quantity">
          <p-sortIcon field="quantity"></p-sortIcon> Cant.
          <p-columnFilter type="text" field="quantity" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="presentation">
          <p-sortIcon field="presentation"></p-sortIcon> Und
          <p-columnFilter type="text" field="presentation" display="menu"></p-columnFilter>
        </th>
        <!--Nuevo-->
        <th class="text-center" pSortableColumn="weight">
          <p-sortIcon field="weight"></p-sortIcon> P. Bruto
          <p-columnFilter type="text" field="weight" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="netWeight">
          <p-sortIcon field="netWeight"></p-sortIcon> P. Neto
          <p-columnFilter type="text" field="netWeight" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="ubication">
          <p-sortIcon field="ubication"></p-sortIcon> Ubicación
          <p-columnFilter type="text" field="ubication" display="menu"></p-columnFilter>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <ng-container *ngIf="!preloadDispatch then NoPreload; else Preload" ></ng-container>
          <ng-template #NoPreload>
            <td pFrozenColumn [frozen]="true" alignFrozen="left">
              <p-tableCheckbox *ngIf="!editOrderFact && !data.inOrder" [value]="data" (click)="deselectedProduction(data)"></p-tableCheckbox>
              <p-tableCheckbox *ngIf="editOrderFact && !data.inOrder" [value]="data" (click)="deselectedProduction(data)"></p-tableCheckbox>
              <p-button *ngIf="editOrderFact && data.inOrder" icon="pi pi-trash" [rounded]="true" severity="danger" (onClick)="seeMsgDeleteRolls(data)"></p-button>
            </td>
          </ng-template>
          <ng-template #Preload>
        </ng-template>
        <td class="text-center">{{rowIndex + 1}}</td>
        <td class="text-center">{{data.numberProduction}}</td>
        <td class="text-center">{{data.orderProduction}}</td>
        <!--<td class="text-center">{{data.client}}</td>-->
        <td class="text-center">{{data.nameClient}}</td>
        <td class="text-center">{{data.item}}</td>
        <td class="text-center">{{data.reference}}</td>
        <td class="text-center textBlue"><b>{{data.quantity | number : '1.2-2'}}</b></td>
        <td class="text-center">{{data.presentation}}</td>
        <td class="text-center">{{data.weight | number : '1.2-2'}}</td>
        <td class="text-center">{{data.netWeight | number : '1.2-2'}}</td>
        <td class="text-center">{{data.ubication}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr *ngIf="!editOrderFact && !preloadDispatch">
        <td colspan="2">Seleccionar: </td>
        <td class="text-center"><p-button icon="pi pi-check-circle" [rounded]="true" severity="success" (onClick)="deselectByFilters()" pTooltip="Seleccionar todo o seleccionar por la información filtrada"></p-button></td>
        <td colspan="9"></td>
      </tr>
    </ng-template>
  </p-table>

  <p-table
    [value]="production"
    *ngIf="load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
      </tr>
    </ng-template>
  </p-table>

  <p-divider></p-divider>

  <!--Botones-->
  <div class="d-grid gap-2 d-md-flex justify-content-md-center">
    <button *ngIf="!editOrderFact" pButton class="p-button-danger" type="button" label="Crear Orden" icon="pi pi-send" [disabled]="load" (click)="validateInformation()"></button>
    <button *ngIf="editOrderFact" pButton class="p-button-danger" type="button" label="Editar Orden" icon="pi pi-pencil" [disabled]="load" (click)="editOrder()"></button>
    <button pButton class="p-button-secondary" type="button" label="Limpiar Campos" icon="pi pi-eraser" [disabled]="load" (click)="clearFields(false)"></button>
  </div>

</p-card>

<!--Mensaje de confirmación de eliminación de bultos-->
<p-toast position="center" key="deleteRoll" (onClose)="onReject('deleteRoll')" [baseZIndex]="5000">
  <ng-template let-message pTemplate="message">
    <div class="flex flex-column" style="flex: 1">
      <div class="text-center">
        <i class="pi pi-exclamation-triangle font-size-48"></i>
        <h4>{{message.summary}}</h4>
        <p>{{message.detail}}</p>
      </div>
      <div class="p-fluid" style="display: flex;">
        <div class="col-6" style="margin-right: 5px;">
          <button type="button" pButton icon="pi pi-check" label="Sí, no está disponible" class="p-button-danger" (click)="deleteRollFromOrderFact(rollSelected, 20, 23)" pTooltip="El bulto seleccionado será ELIMINADO de la orden y cambiará su estado a NO DISPONIBLE."></button>
        </div>
        <div class="col-6">
          <button type="button" pButton icon="pi pi-times" label="Sí, pero vuelve a inventario" (click)="deleteRollFromOrderFact(rollSelected, 20, 19)" class="p-button-warning" pTooltip="El bulto seleccionado será ELIMINADO de la orden y cambiará su estado a DISPONIBLE."></button>
        </div>
      </div>
    </div>
  </ng-template>
</p-toast>

<!--Mensaje de confirmación para eliminación de items-->
<p-toast position="center" key="deleteItem" (onClose)="onReject('deleteItem')" [baseZIndex]="5000">
  <ng-template let-message pTemplate="message">
    <div class="flex flex-column" style="flex: 1">
      <div class="text-center">
        <i class="pi pi-exclamation-triangle font-size-48"></i>
        <h4>{{message.summary}}</h4>
        <p>{{message.detail}}</p>
      </div>
      <div class="p-fluid" style="display: flex;">
        <div class="col-6" style="margin-right: 5px;">
          <button type="button" pButton icon="pi pi-check" label="Sí, volverán" class="p-button-warning" (click)="deleteItemFromOrderFact(itemSelected, 20, 19)" pTooltip="El item seleccionado y sus bultos/rollos serán eliminados de la orden pero VOLVERAN AL INVENTARIO."></button>
        </div>
        <div class="col-6">
          <button type="button" pButton icon="pi pi-times" label="No, no están disponibles" (click)="deleteItemFromOrderFact(itemSelected, 20, 23)" pTooltip="El item seleccionado y sus bultos/rollos serán eliminados de la orden y se colocarán como NO DISPONIBLE(S)." class="p-button-secondary"></button>
        </div>
      </div>
    </div>
  </ng-template>
</p-toast>

<!--Mensaje de confirmación para eliminación de items-->
<p-toast position="center" key="reposition" (onClose)="onReject('reposition')" [baseZIndex]="5000">
  <ng-template let-message pTemplate="message">
    <div class="flex flex-column" style="flex: 1">
      <div class="text-center">
        <i class="pi pi-exclamation-triangle font-size-48"></i>
        <h4>{{message.summary}}</h4>
        <p>{{message.detail}}</p>
      </div>
      <div class="p-fluid" style="display: flex;">
        <div class="col-6" style="margin-right: 5px;">
          <button type="button" pButton icon="pi pi-check" label="Sí" class="p-button-warning" (click)="saveOrderFact()" pTooltip="Se enviarán cantidades diferentes a la que se debían reponer."></button>
        </div>
        <div class="col-6">
          <button type="button" pButton icon="pi pi-times" label="No" (click)="onReject('reposition')" class="p-button-secondary"></button>
        </div>
      </div>
    </div>
  </ng-template>
</p-toast>

<!--Modal de agregar items al pedido-->
<p-dialog [(visible)]="modalAddItems" [style]="{width: '400px'}" [resizable]="true" header="Agregar Referencia" [modal]="true" [contentStyle]="{'overflow':'visible'}">
  <ng-template pTemplate="content">
    <form [formGroup]="formItems" (ngSubmit)="addItemForReposition()">
      <div class="mb-3">
        <div class="row g-4">
          <br><br>
          
          <div class="col-md-12">
            <span class="p-float-label">
              <input formControlName="item" id="item" type="number" pInputText required (keyup.enter)="searchProductByItem()"/>
              <label for="item">Item</label>
            </span>
          </div>
      
          
          <div class="col-md-12">
            <span class="p-float-label">
              <input formControlName="reference" id="reference" list="products" type="text" autocomplete="off" pInputText required (keyup)="searchProductByReference()" (change)="selectedProduct()"/>
              <datalist id="products">
                <option value={{item.prod.prod_Id}} *ngFor="let item of productsModal">{{item.prod.prod_Nombre}}</option>
              </datalist>
              <label for="reference">Referencia</label>
            </span>
          </div>
      
          
          <div class="col-md-6">
            <span class="p-float-label">
              <p-inputNumber formControlName="qty" inputId="qty" mode="decimal" [minFractionDigits]="2" [required]="true"></p-inputNumber>
              <label for="qty">Cantidad</label>
            </span>
          </div>
      
          
          <div class="col-md-6">
            <span class="p-float-label">
              <p-dropdown formControlName="presentation" inputId="presentation" [options]="presentations" optionValue="undMed_Id" optionLabel="undMed_Id" [autoDisplayFirst]="false"></p-dropdown>
              <label for="presentation">Presentación</label>
            </span>
          </div>

          
          <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-center">
            <button pButton pRipple label="Agregar Item" icon="pi pi-check-square" [disabled]="formItems.invalid" type="submit" class="p-button-danger"></button>
            <button pButton pRipple label="Limpiar Campos" icon="pi pi-eraser" type="button" class="p-button-secondary" (click)="formItems.reset()"></button>
          </div>

        </div>
      </div>  
    </form>    
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="modalSaleOrderVsPreload" [style]="{width: '90vw'}" [resizable]="true" header="Comparativa Precargue/Pedido" [modal]="true" [contentStyle]="{'overflow':'visible'}">
  <ng-template pTemplate="content">
    <p><i class="pi pi-exclamation-triangle"></i><b>Nota:</b> Existen diferencias entre el pedido y el precargue.</p> 
   <!--* Tablas-->
  <div class="row g-4">

    <!--* PEDIDO -->
    <div class="col-sm-12 col-md-6 col-xxl-6">
      <!--* Titulo PEDIDO -->
      <p-toolbar styleClass="mb-2">
        <ng-template pTemplate="left">
        </ng-template>
        <ng-template pTemplate="center">
          <div class="justify-content-center">
            <h2><b class="mr-2" [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-cart-plus"></i> Detalles del Pedido</b></h2>
          </div>
        </ng-template>
        <ng-template pTemplate="right">
        </ng-template>
      </p-toolbar>
      
      <p-table 
        #tableSaleOrder
        [value]="comparativeProduct"
        [resizableColumns]="true"
        styleClass="p-datatable-gridlines p-datatable-sm"
        responsiveLayout="scroll"
        [rowHover]="true"
        [scrollable]="true"
        scrollHeight="50rem"
        *ngIf="!load">
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">#</th>
            <th class="text-center">Pedido</th>
            <th class="text-center">Item</th>
            <th class="text-center">Referencia</th>
            <th class="text-center">Cantidad</th> 
            <th class="text-center">Presentación</th> 
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
          <tr class="cursor">
            <td class="text-center">{{rowIndex + 1}}</td>
            <td class="text-center">{{ data.consecutivo }}</td>
            <td class="text-center"><b>{{ data.id_Producto }}</b></td>
            <td class="text-center">{{ data.producto }}</td>
            <td class="text-center"><b>{{ data.cant_Pendiente | number : '1.2-2' }}</b></td>
            <td class="text-center">{{ data.presentacion }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
    
    <!--* PRECARGUE-->
    <div class="col-sm-12 col-md-6 col-xxl-6">
       <!--* Titulo PRECARGUE -->
       <p-toolbar styleClass="mb-2">
        <ng-template pTemplate="left">
        </ng-template>
        <ng-template pTemplate="center">
          <h2><b class="mr-2" [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-truck"></i> Detalles del Precargue</b></h2>
        </ng-template>
        <ng-template pTemplate="right">
        </ng-template>
      </p-toolbar>
      
      <p-table 
        #tablePreload
        [value]="comparativePreload"
        [resizableColumns]="true"
        styleClass="p-datatable-gridlines p-datatable-sm"
        responsiveLayout="scroll"
        [rowHover]="true"
        [scrollable]="true"
        scrollHeight="50rem"
        *ngIf="!load">
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">#</th>
            <th class="text-center">Precargue</th>
            <th class="text-center">Item</th>
            <th class="text-center">Referencia</th>
            <th class="text-center">Cantidad</th> 
            <th class="text-center">Presentación</th> 
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
          <tr class="cursor">
            <td class="text-center">{{rowIndex + 1}}</td>
            <td class="text-center">{{ data.movement }}</td>
            <td class="text-center"><b>{{ data.item }}</b></td>
            <td class="text-center">{{ data.reference }}</td>
            <td class="text-center"><b>{{ data.quantity | number : '1.2-2'}}</b></td>
            <td class="text-center">{{ data.presentation }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
  </ng-template>
</p-dialog>


