<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-5 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Orden de Facturación</h2>
    </div>

    <div class="mb-5">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="my-5">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-book"></i> Datos de la orden.</h4>
  </div>

  <form [formGroup]="formDataOrder">
    <div class="row g-4">

      <!--Type Document-->
      <!--<div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <p-dropdown formControlName="typeDoc"  (onChange)="validateTypeDoc()" inputId="typeDoc" [autoDisplayFirst]="true" [options]="typesDoc" optionLabel="tpDoc_Nombre" optionValue="tpDoc_Id"></p-dropdown>
          <label for="typeDoc">Tipo Documento</label>
        </span>
      </div>-->

      <!-- Sale Order -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label"><!--[readonly]="formDataOrder.value.typeDoc == 'REPO' ? true : false"-->
          <input formControlName="saleOrder" id="saleOrder" type="text"  pInputText (keyup.enter)="getSalesOrders()"/>
          <label for="saleOrder">Pedido</label>
        </span>
      </div>

      <!-- Fact -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <input formControlName="fact" id="Factura" type="text" pInputText required/>
          <label for="Factura">Factura</label>
        </span>
      </div> -->

      <!-- Id Client -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="idClient" id="idClient" type="text" pInputText required readonly/>
          <label for="idClient">Id Cliente</label>
        </span>
      </div>

      <!-- Client -->
      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6 col-xxl-6">
        <span class="p-float-label"><!--formDataOrder.value.typeDoc == 'REPO' ? false : true-->
          <input formControlName="client" id="Cliente" list="clientes" type="text" autocomplete="off" pInputText required readonly (keyup)="getClients()" (change)="selectedClient()"/>
          <datalist id="clientes">
            <option value={{item.cli_Id}} *ngFor="let item of clients">{{item.cli_Nombre}}</option>
          </datalist>
          <label for="Cliente">Cliente</label>
        </span>
      </div>

      <!-- Item -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="item" id="IdProducto" type="text" pInputText required (keyup.enter)="searchProductByItem()"/>
          <label for="IdProducto">Item</label>
        </span>
      </div> -->

      <!-- Reference -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-9 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="reference" id="reference" list="products" type="text" autocomplete="off" pInputText required (keyup)="getProducts()" (change)="selectedProduct()"/>
          <datalist id="products">
            <option value={{item.prod.prod_Id}} *ngFor="let item of products">{{item.prod.prod_Nombre}}</option>
          </datalist>
          <label for="reference">Referencia</label>
        </span>
      </div> -->

      <!-- Observacion -->
      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
        <span class="p-float-label">
          <textarea formControlName="observation" [rows]="1" maxlength="200" pInputTextarea></textarea>
          <label for="textarea">Observación</label>
        </span>
      </div>
    </div>
  </form>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Productos del Pedido.</h4>
  </div>

  <!--Productos del pedido-->
  <!--<p-toolbar styleClass="mb-4 gap-2" *ngIf="formDataOrder.value.typeDoc == 'REPO'">
    <ng-template pTemplate="left">
        <button pButton pRipple label="Agregar Item" icon="pi pi-plus" class="p-button-danger mr-2" (click)="modalAddItems = true"></button>
    </ng-template>

    <ng-template pTemplate="right">
    </ng-template>
  </p-toolbar>-->

  <p-table
    [value]="products"
    selectionMode="single"
    [(selection)]="selectedProductSaleOrder"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    dataKey="id_Producto"
    (onRowSelect)="this.getProducts()"
    (onRowUnselect)="this.getProducts()">
    <ng-template pTemplate="header">
      <tr>
        <th>Pedido</th>
        <th>Id Cliente</th>
        <th>Cliente</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr [pSelectableRow]="data">
        <td>{{data.consecutivo}}</td>
        <td>{{data.id_Cliente}}</td>
        <td>{{data.cliente}}</td>
        <td>{{data.id_Producto}}</td>
        <td>{{data.producto}}</td>
        <td>{{data.cant_Pendiente | number : '1.2-2'}}</td>
        <td>{{data.presentacion}}</td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Consolidado de Productos Elegidos</h4>
  </div>

  <!--Consolidado-->
  <p-table
    [value]="consolidatedProduction"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    dataKey="item">
    <ng-template pTemplate="header">
      <tr>
        <th>#</th>
        <th>Pedido</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Cantidad Rollos</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td>{{rowIndex + 1}}</td>
        <td>{{data.saleOrder}}</td>
        <td>{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td>{{totalQuantityByProduct(data.item) | number : '1.2-2'}}</td>
        <td>{{totalCountProductionByProduct(data.item) | number : '1.2-2'}}</td>
        <td>{{data.presentation}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="5">Total</td>
        <td colspan="2">{{productionSelected.length | number : '1.2-2'}}</td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Rollos Disponibles.</h4>
  </div>

  <!--Rollos disponibles-->
  <p-table
    #tableProduction
    [value]="production"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    dataKey="numberProduction"
    [(selection)]="productionSelected"
    *ngIf="!load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>#</th>
        <th class="text-center" pSortableColumn="numberProduction">
          <p-sortIcon field="numberProduction"></p-sortIcon> Rollo
          <p-columnFilter type="text" field="numberProduction" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="orderProduction">
          <p-sortIcon field="orderProduction"></p-sortIcon> OT
          <p-columnFilter type="text" field="orderProduction" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="client">
          <p-sortIcon field="client"></p-sortIcon> Id Cliente
          <p-columnFilter type="text" field="client" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="nameClient">
          <p-sortIcon field="nameClient"></p-sortIcon> Cliente
          <p-columnFilter type="text" field="nameClient" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="item">
          <p-sortIcon field="item"></p-sortIcon> Item
          <p-columnFilter type="text" field="item" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="reference">
          <p-sortIcon field="reference"></p-sortIcon> Referencia
          <p-columnFilter type="text" field="reference" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="quantity">
          <p-sortIcon field="quantity"></p-sortIcon> Cantidad
          <p-columnFilter type="text" field="quantity" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="presentation">
          <p-sortIcon field="presentation"></p-sortIcon> Medida
          <p-columnFilter type="text" field="presentation" display="menu"></p-columnFilter>
        </th>
        <!--Nuevo-->
        <th class="text-center" pSortableColumn="ubication">
          <p-sortIcon field="ubication"></p-sortIcon> Ubicación
          <p-columnFilter type="text" field="ubication" display="menu"></p-columnFilter>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-tableCheckbox [value]="data" (click)="selectedProduction(data)"></p-tableCheckbox>
        </td>
        <td class="text-center">{{rowIndex + 1}}</td>
        <td class="text-center">{{data.numberProduction}}</td>
        <td class="text-center">{{data.orderProduction}}</td>
        <td class="text-center">{{data.client}}</td>
        <td>{{data.nameClient}}</td>
        <td class="text-center">{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td class="text-center">{{data.quantity | number : '1.2-2'}}</td>
        <td class="text-center">{{data.presentation}}</td>
        <!--Nuevo-->
        <td class="text-center">{{data.ubication}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="2">Seleccionar: </td>
        <td class="text-center"><p-button icon="pi pi-check-circle" [rounded]="true" severity="success" (onClick)="selectByFilters()" pTooltip="Seleccionar todo o seleccionar por la información filtrada"></p-button></td>
        <td><p-inputNumber [(ngModel)]="qtyToSend" mode="decimal" [minFractionDigits]="2" [maxFractionDigits]="2" class="length"> </p-inputNumber></td>
        <td class="text-center"><p-button icon="pi pi-search-plus" [rounded]="true" severity="warning" (onClick)="selectByQuantity()" pTooltip="Seleccionar por cantidad"></p-button></td>
        <td colspan="3">Total</td>
        <!--Nuevo-->
        <td class="text-center">{{totalProduccionSearched() | number : '1.2-2'}}</td>
        <td colspan="2"></td>
      </tr>
    </ng-template>
  </p-table>

  <p-table
    [value]="production"
    *ngIf="load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Rollos Seleccionados.</h4>
  </div>

  <!--Rollos seleccionados-->
  <p-table
    #tableProductionSelected
    [value]="productionSelected"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    [(selection)]="production"
    dataKey="numberProduction"
    *ngIf="!load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="deselectedAllProduction()"></p-checkbox>
        </th>
        <th>#</th>
        <th class="text-center" pSortableColumn="numberProduction">
          <p-sortIcon field="numberProduction"></p-sortIcon> Rollo
          <p-columnFilter type="text" field="numberProduction" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="orderProduction">
          <p-sortIcon field="orderProduction"></p-sortIcon> OT
          <p-columnFilter type="text" field="orderProduction" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="client">
          <p-sortIcon field="client"></p-sortIcon> Id Cliente
          <p-columnFilter type="text" field="client" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="nameClient">
          <p-sortIcon field="nameClient"></p-sortIcon> Cliente
          <p-columnFilter type="text" field="nameClient" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="item">
          <p-sortIcon field="item"></p-sortIcon> Item
          <p-columnFilter type="text" field="item" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="reference">
          <p-sortIcon field="reference"></p-sortIcon> Referencia
          <p-columnFilter type="text" field="reference" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="quantity">
          <p-sortIcon field="quantity"></p-sortIcon> Cantidad
          <p-columnFilter type="text" field="quantity" display="menu"></p-columnFilter>
        </th>
        <th class="text-center" pSortableColumn="presentation">
          <p-sortIcon field="presentation"></p-sortIcon> Medida
          <p-columnFilter type="text" field="presentation" display="menu"></p-columnFilter>
        </th>
        <!--Nuevo-->
        <th class="text-center" pSortableColumn="ubication">
          <p-sortIcon field="ubication"></p-sortIcon> Ubicación
          <p-columnFilter type="text" field="ubication" display="menu"></p-columnFilter>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-tableCheckbox [value]="data" (click)="deselectedProduction(data)"></p-tableCheckbox>
        </td>
        <td class="text-center">{{rowIndex + 1}}</td>
        <td class="text-center">{{data.numberProduction}}</td>
        <td class="text-center">{{data.orderProduction}}</td>
        <td class="text-center">{{data.client}}</td>
        <td>{{data.nameClient}}</td>
        <td class="text-center">{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td class="text-center">{{data.quantity | number : '1.2-2'}}</td>
        <td class="text-center">{{data.presentation}}</td>
        <!--Nuevo-->
        <td class="text-center">{{data.ubication}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="2">Seleccionar: </td>
        <td class="text-center"><p-button icon="pi pi-check-circle" [rounded]="true" severity="success" (onClick)="deselectByFilters()" pTooltip="Seleccionar todo o seleccionar por la información filtrada"></p-button></td>
        <!--Nuevo-->
        <td colspan="8"></td>
      </tr>
    </ng-template>
  </p-table>

  <p-table
    [value]="production"
    *ngIf="load">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem" pFrozenColumn [frozen]="true" alignFrozen="left">
          <p-checkbox (click)="selectedAllProduction()"></p-checkbox>
        </th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
        <td><p-skeleton></p-skeleton></td>
      </tr>
    </ng-template>
  </p-table>

  <p-divider></p-divider>

  <div class="d-grid gap-2 d-md-flex justify-content-md-center">
    <button pButton class="p-button-danger" type="button" label="Crear Orden" icon="pi pi-send" [disabled]="load" (click)="validateInformation()"></button>
    <button pButton class="p-button-secondary" type="button" label="Limpiar Campos" icon="pi pi-eraser" [disabled]="load" (click)="clearFields()"></button>
  </div>

</p-card>

<!--Modal de agregar items al pedido-->
<!--<p-dialog [(visible)]="modalAddItems" [style]="{width: '400px'}" [resizable]="true" header="Agregar Referencia" [modal]="true" [contentStyle]="{'overflow':'visible'}">
  <ng-template pTemplate="content">
    <form [formGroup]="formItems" (ngSubmit)="addItemToSaleOrder()">
      <div class="mb-3">
        <div class="row g-4">
          <br><br>
          
          <div class="col-md-12">
            <span class="p-float-label">
              <input formControlName="item" id="item" type="number" pInputText required (keyup.enter)="searchProductByItem()"/>
              <label for="item">Item</label>
            </span>
          </div>
      
          
          <div class="col-md-12">
            <span class="p-float-label">
              <input formControlName="reference" id="reference" list="products" type="text" autocomplete="off" pInputText required (keyup)="searchProductByReference()" (change)="selectedProduct()"/>
              <datalist id="products">
                <option value={{item.prod.prod_Id}} *ngFor="let item of productsModal">{{item.prod.prod_Nombre}}</option>
              </datalist>
              <label for="reference">Referencia</label>
            </span>
          </div>
      
          
          <div class="col-md-6">
            <span class="p-float-label">
              <p-inputNumber formControlName="qty" inputId="qty" mode="decimal" [minFractionDigits]="2" [required]="true"></p-inputNumber>
              <label for="qty">Cantidad</label>
            </span>
          </div>
      
          
          <div class="col-md-6">
            <span class="p-float-label">
              <p-dropdown formControlName="presentation" inputId="presentation" [options]="presentations" optionValue="undMed_Id" optionLabel="undMed_Id" [autoDisplayFirst]="false"></p-dropdown>
              <label for="presentation">Presentación</label>
            </span>
          </div>

          
          <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-center">
            <button pButton pRipple label="Agregar Item" icon="pi pi-check-square" [disabled]="formItems.invalid" type="submit" class="p-button-danger"></button>
            <button pButton pRipple label="Limpiar Campos" icon="pi pi-eraser" type="button" class="p-button-secondary" (click)="formItems.reset()"></button>
          </div>

        </div>
      </div>  
    </form>    
  </ng-template>
</p-dialog>--> 
