<div class="d-flex justify-content-center overlay" *ngIf="load">
    <div style="margin: auto;">
      <p-progressSpinner></p-progressSpinner>
    </div>
  </div>

<p-table 
*ngIf="!load"
dataKey="Id" 
[value]="registros"
[resizableColumns]="true"
columnResizeMode="expand"
styleClass="p-datatable-gridlines p-datatable-sm"
responsiveLayout="scroll"  
[scrollable]="true"
scrollHeight="50rem"
editMode="row">
    <ng-template pTemplate="caption">
        <div class="row g-4 p-3">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-3 col-xxl-3">
                <button pButton pRipple label="Nuevo Registro" icon="pi pi-plus" class="p-button-success" (click)="agregarFila()"></button>
            </div>
        </div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th colspan="11"></th>
            <th colspan="3" class="text-center">Calibre (3 Mediciones)</th>
            <th colspan="6"></th>
        </tr>
        <tr>
          <th style="min-width : 100px" pFrozenColumn [frozen]="true" alignFrozen="left">OT</th>
          <th style="min-width : 60px">Ronda</th>
          <th style="min-width : 60px">Turno</th>
          <th style="min-width : 60px">Maq.</th>
          <th style="min-width : 200px">Nombre Cliente</th>
          <th style="min-width : 300px">Nombre Referencia</th>
          <th style="min-width : 100px">Rollo</th>
          <th style="min-width : 80px">Pigmento</th>
          <th style="min-width : 90px">Ancho Tub.</th>
          <th style="min-width : 100px">Peso Metro (g)</th>
          <th style="min-width : 100px">Ancho (Cm)</th>
          <th style="min-width : 80px">Min</th>
          <th style="min-width : 80px">Max</th>
          <th style="min-width : 80px">Prom</th>
          <th style="min-width : 100px">Apariencia</th>
          <th style="min-width : 100px">Tratado</th>
          <th style="min-width : 100px">Rasgado</th>
          <th style="min-width : 100px">Tipo Bobina</th>
          <th style="min-width : 200px">Observacion</th>
          <th style="min-width : 100px" pFrozenColumn [frozen]="true" alignFrozen="right">Acciones</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-registro let-editing="editing" let-ri="rowIndex">
        <tr [pEditableRow]="registro">
            <!--OT-->
             <td pFrozenColumn [frozen]="true" alignFrozen="left">
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-inputNumber type="number" [useGrouping]="false" [(ngModel)]="registro.OT" pAutoFocus [autofocus]="true" (keyup.enter)="consultarOT(registro, ri)"></p-inputNumber>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.OT}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Ronda-->
            <td>
                {{registro.Ronda}}
            </td>
             <!--Turno-->
             <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-dropdown [options]="turnos" appendTo="body" [(ngModel)]="registro.Turno" optionLabel="turno_Nombre" optionValue="turno_Id" [style]="{'width':'100%'}"></p-dropdown>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Turno}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Maquina-->
            <td>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                      <p-inputNumber type="number" [useGrouping]="false" [(ngModel)]="registro.Maquina"></p-inputNumber>
                  </ng-template>
                  <ng-template pTemplate="output">
                      {{registro.Maquina}}
                  </ng-template>
                </p-cellEditor>
            </td>
            <!--Cliente-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <input pInputText type="text" [(ngModel)]="registro.Cliente">
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Cliente}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Referencia-->
            <td>
              <p-cellEditor>
                  <ng-template pTemplate="input">
                      <input pInputText type="text" [(ngModel)]="registro.Referencia">
                  </ng-template>
                  <ng-template pTemplate="output">
                      {{registro.Referencia}}
                  </ng-template>
              </p-cellEditor>
            </td>
            <!--Rollo-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-inputNumber type="number" [useGrouping]="false" [(ngModel)]="registro.Rollo"></p-inputNumber>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Rollo}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Pigmento-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-dropdown [options]="pigmentos" appendTo="body" [(ngModel)]="registro.Pigmento" optionLabel="pigmt_Nombre" optionValue="pigmt_Id" [style]="{'width':'100%'}"></p-dropdown>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Pigmento}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Ancho Tubular-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-inputNumber type="number" mode="decimal" [maxFractionDigits]="2" [(ngModel)]="registro.AnchoTubular"></p-inputNumber>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.AnchoTubular | number: '1.2-2'}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Peso-->
            <td>
              <p-cellEditor>
                  <ng-template pTemplate="input">
                      <p-inputNumber type="text" mode="decimal" [maxFractionDigits]="2" [(ngModel)]="registro.PesoMetro"></p-inputNumber>
                  </ng-template>
                  <ng-template pTemplate="output">
                      {{registro.PesoMetro | number: '1.2-2'}}
                  </ng-template>
              </p-cellEditor>
            </td>
            <!--Ancho-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-inputNumber type="number" mode="decimal" [maxFractionDigits]="2" [(ngModel)]="registro.Ancho"></p-inputNumber>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Ancho | number: '1.2-2'}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Calibre Min-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-inputNumber type="number" mode="decimal" [maxFractionDigits]="2"  [(ngModel)]="registro.CalMin"></p-inputNumber>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.CalMin | number: '1.2-2'}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Calibre Max-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-inputNumber type="number" mode="decimal" [maxFractionDigits]="2" [(ngModel)]="registro.CalMax"></p-inputNumber>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.CalMax | number: '1.2-2'}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Calibre Prom-->
            <td>
              <p-cellEditor>
                  <ng-template pTemplate="input">
                      <p-inputNumber type="number" mode="decimal" [maxFractionDigits]="2" [(ngModel)]="registro.CalProm"></p-inputNumber>
                  </ng-template>
                  <ng-template pTemplate="output">
                      {{registro.CalProm | number : '1.2-2'}}
                  </ng-template>
              </p-cellEditor>
            </td>
            <!--Apariencia-->
            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                    <p-dropdown [options]="apariencias" appendTo="body" [(ngModel)]="registro.Apariencia" [style]="{'width':'100%'}"></p-dropdown>
                </ng-template>
                <ng-template pTemplate="output">
                    {{registro.Apariencia}}
                </ng-template>
              </p-cellEditor>
            </td>
            <!--Tratado-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-dropdown [options]="eleccion" appendTo="body" [(ngModel)]="registro.Tratado" [style]="{'width':'100%'}"></p-dropdown>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Tratado}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Rasgado-->
            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                    <p-dropdown [options]="eleccion" appendTo="body" [(ngModel)]="registro.Rasgado" [style]="{'width':'100%'}"></p-dropdown>
                </ng-template>
                <ng-template pTemplate="output">
                    {{registro.Rasgado}}
                </ng-template>
            </p-cellEditor>
            </td>
            <!--Tipo Bobina-->
            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                    <p-dropdown [options]="tiposBobinas" appendTo="body" [(ngModel)]="registro.TipoBobina" [style]="{'width':'100%'}"></p-dropdown>
                </ng-template>
                <ng-template pTemplate="output">
                    {{registro.TipoBobina}}
                </ng-template>
            </p-cellEditor>
            </td>
            <!--Observación-->
            <td>
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <input pInputText type="text" [(ngModel)]="registro.Observacion">
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{registro.Observacion}}
                    </ng-template>
                </p-cellEditor>
            </td>
            <!--Botones-->
            <td pFrozenColumn [frozen]="true" alignFrozen="right">
                <div class="flex align-items-center justify-content-center gap-2">
                    <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" (click)="onRowEditInit(registro, ri)" class="p-button-rounded p-button-text"></button>
                    <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow icon="pi pi-check" (click)="mostrarEleccion(registro)" class="p-button-rounded p-button-text p-button-success mr-2"></button>
                    <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" (click)="onRowEditCancel(registro, ri)" class="p-button-rounded p-button-text p-button-danger"></button>
                </div>
            </td>
        </tr>
    </ng-template>
</p-table>

<p-toast position="center" key="eleccion" (onClose)="onReject('eleccion')"  >
    <ng-template let-message pTemplate="message" let-item>
      <div class="flex flex-column" style="flex: 1">
        <div class="text-center">
          <i class="pi pi-exclamation-triangle font-size-48"></i>
          <h4>{{message.summary}}</h4>
          <p>{{message.detail}}</p>
        </div>
        <div class="p-fluid" style="display: flex;">
          <div class="col-6" style="margin-right: 5px;">
            <button type="button" pButton (click)="validarId(item)" icon="pi pi-check" label="Si" class="p-button-success"></button>
          </div>
          <div class="col-6">
            <button type="button" pButton (click)="onReject('eleccion')" icon="pi pi-times" label="No" class="p-button-secondary"></button>
          </div>
        </div>
      </div>
    </ng-template>
</p-toast>

