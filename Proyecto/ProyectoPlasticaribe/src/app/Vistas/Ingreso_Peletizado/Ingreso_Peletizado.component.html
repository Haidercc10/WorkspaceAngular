<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Ingreso de Peletizado</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <!--Crear Falla-->
  <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
    <button pButton pRipple class="p-button-danger" icon="pi pi-exclamation-triangle" label="Crear Falla" id="botones1" (click)="modalFails = true"></button>
  </div>

  <div class="mb-5">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-cloud-download"></i>  Registro de Peletizado</h4>
  </div> 

  <!--Formulario-->
  <form [formGroup]="form">
    <div class="mb-3" id="formulario">
      <div class="row g-4">

        <!-- Proceso -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-2">
          <span class="p-float-label">
            <p-dropdown formControlName="process" id="process" (onChange)="enableTypeRecovery()" [options]="process" optionLabel="proceso_Nombre" optionValue="proceso_Id" [autoDisplayFirst]="false"></p-dropdown>
            <label for="process">Proceso*</label>
          </span>
        </div>

        <!-- Tipo recuperado -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-2">
          <span class="p-float-label">
              <p-dropdown formControlName="typeRecovery" inputId="typeRecovery" (onChange)="enableForm()" [autoDisplayFirst]="false" [options]="typesRecovery" optionLabel="tpRecu_Nombre" optionValue="tpRecu_Id" [required]="true" [filter]="true" filterBy="tpRecu_Nombre"></p-dropdown>
              <label for="typeRecovery">Tipo recuperado*</label>
          </span>
        </div>
        
        <!-- OT -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1">
          <span class="p-float-label">
            <p-inputNumber formControlName="ot" id="ot" type="number" (keyup.enter)="getOrderProduction()" [useGrouping]="false" [readonly]="form.value.process == null" pTooltip="{{form.value.process == null ? 'Debe llenar los campos TIPO RECUPERADO Y PROCESO' : null}}" tooltipPosition="top"></p-inputNumber>
            <label for="ot">OT</label>
          </span>
        </div>

        <!-- Rollo/Bulto -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1">
          <span class="p-float-label">
            <p-inputNumber formControlName="roll" id="roll" type="number" (keyup.enter)="getRollProduction()" [readonly]="form.value.process == null || form.value.typeRecovery != 'ROLLO'" [useGrouping]="false" pTooltip="{{form.value.process == null ? 'Debe llenar los campos TIPO RECUPERADO Y PROCESO' : null}}" tooltipPosition="top"></p-inputNumber>
            <label for="roll">Rollo/Bulto</label>
          </span>
        </div>

        <!--Producto-->

        <!-- Materiales -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-2">
          <span class="p-float-label">
            <p-dropdown formControlName="material" id="material" [readonly]="true" [options]="materials" optionLabel="material_Nombre" optionValue="material_Id" [autoDisplayFirst]="false"></p-dropdown>
            <label for="material">Material*</label>
          </span>
        </div>

         <!-- Cantidad -->
         <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1">
          <span class="p-float-label">
            <p-inputNumber formControlName="quantity" id="quantity" type="number" [autofocus]="true" [useGrouping]="true" [minFractionDigits]="2" [maxFractionDigits]="2"></p-inputNumber>
            <label for="quantity">Peso (Kg)*</label>
          </span>
        </div>

        <!--Materia Prima-->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-3">
          <span class="p-float-label">
            <input formControlName="matprima" id="matprima" list="materiaprima" (change)="selectMatPrimas()" type="text" pInputText required/>
            <datalist id="materiaprima">
              <option value={{item.id}} *ngFor="let item of matPrimas">{{item.matPrima}}</option>
            </datalist>
            <label for="matprima">Materia Prima*</label>
          </span>
        </div>

        <!-- No conformidad -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-2">
          <span class="p-float-label">
            <p-dropdown formControlName="fail" id="fail" [options]="fails" optionLabel="falla_Nombre" optionValue="falla_Id" [autoDisplayFirst]="false" [filter]="true" filterBy="falla_Nombre"></p-dropdown>
            <label for="fail">No conformidad*</label>
          </span>
        </div>

        <!--Observación-->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-12 col-xl-12 col-xxl-10">
          <span class="p-float-label">
            <textarea formControlName="observation" [rows]="1"  maxlength="200" pInputTextarea></textarea>
            <label for="textarea">Observación</label>
          </span>
        </div>

        <!--Botones de adición-->
        <div>
          <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <button pButton class="p-button-danger" id="agregar" type="button" [disabled]="form.invalid" label="Añadir Peletizado" icon="pi pi-send" (click)="validateForm()"></button>
            <button pButton class="p-button-secondary" id="limpiarCampos" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearFields()"> </button>
          </div>
        </div>

      </div>
    </div>
  </form>     

  <p-divider></p-divider>
  
  <!--Subtitulo tabla-->
  <div class="mb-5">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-list"></i>  Registros de recuperados agregados</h4>
  </div> 

  <!--Tabla de registros-->
  <div class="mb-4">
    <p-table
      #dt
      *ngIf="!load"
      [value]="recoveries"
      columnResizeMode="expand"
      styleClass="p-datatable-sm"
      responsiveLayout="scroll"
      [rowHover]="true"
      [scrollable]="true"
      scrollHeight="50rem">
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">#</th>
            <th class="text-center">Recuperado</th>
            <th class="text-center">OT</th>
            <th class="text-center">Rollo</th>
            <th class="text-center">Item</th>
            <th class="text-center">Referencia</th>
            <th class="text-center">Material</th>
            <th class="text-center">Peso</th>
            <th class="text-center">Mat. Prima</th>
            <th class="text-center">Proceso</th>
            <th class="text-center">No conformidad</th>
            <th class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">Quitar</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
          <tr>
            <td class="text-center">{{rowIndex + 1}}</td>
            <td class="text-center"><b>{{data.TpRecu_Id}}</b></td>
            <td class="text-center">{{data.OT}}</td>
            <td class="text-center">{{data.Rollo_Id}}</td>
            <td class="text-center">{{data.Prod_Id}}</td>
            <td class="text-center"><b>{{data.Prod_Nombre}}</b></td>
            <td class="text-center">{{data.Material_Nombre}}</td>
            <td class="text-center"><b>{{data.IngPel_Cantidad | number : '1.2-2'}}</b></td>
            <td class="text-center">{{data.MatPri_Nombre}}</td>
            <td class="text-center">{{data.Proceso_Nombre | uppercase}}</td>
            <td class="text-center"><b>{{data.Falla_Nombre}}</b></td>
            <td class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">
              <p-button icon="pi pi-trash" [rounded]="true" (click)="confirmQuitRecord(rowIndex)" severity="danger"></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="12"><h6 class="bold">No hay registros agregados.</h6></td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td class="text-right" colspan="7">Totales</td>
            <td class="text-center">{{totalQty() | number : '1.2-2'}}</td>
            <td colspan="4"></td>
          </tr>
        </ng-template>
    </p-table>
  </div>
  
   <!--Botones de registro-->
   <div class="mb-3">
    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
      <button pButton class="p-button-danger" id="agregar" type="button" [disabled]="recoveries.length == 0" label="Registrar Peletizado" icon="pi pi-send" (click)="savePeletizados()"></button>
      <button pButton class="p-button-secondary" id="limpiarCampos" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearAll()"> </button>
    </div>
  </div>

</p-card>

<!-- Modal fallas tecnicas -->
<p-dialog [modal]="true" header="Creación de Fallas"  [draggable]="false" [contentStyle]="{'overflow':'visible'}" [(visible)]="modalFails" [style]="{width: '400px', height: 'auto'}">
  <ng-template pTemplate="content">
    <app-Crear_Fallas></app-Crear_Fallas>
  </ng-template>  
</p-dialog> 

<!--Confirmacion de quitar bulto de la tabla.-->
<p-toast position="center" key="delete" [baseZIndex]="5000">
  <ng-template let-message pTemplate="message">
    <div class="flex flex-column" style="flex: 1">
      <div class="text-center">
        <i class="pi pi-exclamation-triangle font-size-48"></i>
        <h4>{{message.summary}}</h4>
        <p>{{message.detail}}</p>
      </div>
      <div class="p-fluid" style="display: flex;">
        <div class="col-6" style="margin-right: 5px;">
          <button type="button" pButton icon="pi pi-check" label="Sí" (click)="quitRecordTable()" class="p-button-warning" pTooltip="Se quitará el registro seleccionado de la tabla."></button>
        </div>
        <div class="col-6">
          <button type="button" pButton icon="pi pi-times" label="No" (click)="onReject()" class="p-button-secondary"></button>
        </div>
      </div>
    </div>
  </ng-template>
</p-toast>

