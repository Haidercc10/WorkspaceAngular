<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Orden de Facturación (Pallets)</h2>
    </div>

    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-book"></i> Datos de la orden.</h4>
  </div>

  <!--Formulario-->
  <form [formGroup]="form">
    <div class="row g-4">

      <!-- Sale Order -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="saleOrder" id="saleOrder" type="text" pInputText (keyup.enter)="getSalesOrders()"/>
          <label for="saleOrder">Pedido</label>
        </span>
      </div>

      <!-- Fact -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <input formControlName="fact" id="Factura" type="text" pInputText required/>
          <label for="Factura">Factura</label>
        </span>
      </div> -->

      <!-- Id Client -->
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="idClient" id="idClient" type="text" pInputText required readonly/>
          <label for="idClient">Id Cliente</label>
        </span>
      </div>

      <!-- Client -->
      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6 col-xxl-6">
        <span class="p-float-label">
          <input formControlName="client" id="Cliente" list="clientes" type="text" autocomplete="off" pInputText required readonly (keyup)="getClients()" (change)="selectedClient()"/>
          <datalist id="clientes">
            <option value={{item.cli_Id}} *ngFor="let item of clients">{{item.cli_Nombre}}</option>
          </datalist>
          <label for="Cliente">Cliente</label>
        </span>
      </div>

      <!-- Item -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-3 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="item" id="IdProducto" type="text" pInputText required (keyup.enter)="searchProductByItem()"/>
          <label for="IdProducto">Item</label>
        </span>
      </div> -->

      <!-- Reference -->
      <!-- <div class="col-xs-12 col-sm-12 col-md-9 col-lg-3 col-xl-3 col-xxl-3">
        <span class="p-float-label">
          <input formControlName="reference" id="reference" list="products" type="text" autocomplete="off" pInputText required (keyup)="getProducts()" (change)="selectedProduct()"/>
          <datalist id="products">
            <option value={{item.prod.prod_Id}} *ngFor="let item of products">{{item.prod.prod_Nombre}}</option>
          </datalist>
          <label for="reference">Referencia</label>
        </span>
      </div> -->

      <!-- Observacion -->
      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
        <span class="p-float-label">
          <textarea formControlName="observation" [rows]="1" maxlength="200" pInputTextarea></textarea>
          <label for="textarea">Observación</label>
        </span>
      </div>

    </div>
  </form>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Productos del Pedido.</h4>
  </div>

  <!--Productos del pedido-->
  <p-table
    [value]="products"
    selectionMode="single"
    [(selection)]="selectedProductSaleOrder"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    dataKey="id_Producto"
    (onRowSelect)="this.getProducts2()"
    (onRowUnselect)="this.getProducts2()">
    <ng-template pTemplate="header">
      <tr>
        <th class="text-center">Pedido</th>
        <th class="text-center">Id Cliente</th>
        <th class="text-center">Cliente</th>
        <th class="text-center">Item</th>
        <th class="text-center">Referencia</th>
        <th class="text-center">Cantidad</th>
        <th class="text-center">Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr [pSelectableRow]="data">
        <td class="text-center">{{data.consecutivo}}</td>
        <td class="text-center">{{data.id_Cliente}}</td>
        <td class="text-center">{{data.cliente}}</td>
        <td class="text-center">{{data.id_Producto}}</td>
        <td class="text-center">{{data.producto}}</td>
        <td class="text-center">{{data.cant_Pendiente | number : '1.2-2'}}</td>
        <td class="text-center">{{data.presentacion}}</td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Consolidado de Productos Elegidos</h4>
  </div>

  <!--Consolidado Pallets-->
  <p-table
    [value]="infoConsolidate"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    dataKey="item">
    <ng-template pTemplate="header">
      <tr>
        <th class="text-center">#</th>
        <th class="text-center">Pedido</th>
        <th class="text-center">Item</th>
        <th class="text-center">Referencia</th>
        <th class="text-center">Cantidad</th>
        <th class="text-center">Cantidad Rollos</th>
        <th class="text-center">Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td class="text-center">{{rowIndex + 1}}</td>
        <td class="text-center">{{data.saleOrder}}</td>
        <td class="text-center">{{data.item}}</td>
        <td class="text-center">{{data.reference}}</td>
        <td class="text-center">{{qtyConsolidateForItem(data.item) | number : '1.2-2'}}</td>
        <td class="text-center">{{qtyRollsForItem(data.item) | number}}</td>
        <td class="text-center">{{data.presentation}}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td class="text-right" colspan="5">Total</td>
        <td class="text-center">{{totalQtySelectedRolls()}}</td>
        <td></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-th-large"></i> Pallets/Rollos Disponibles.</h4>
  </div>

  <!--Pallets-->
  <p-table 
    #t1
    [value]="pallets"
    dataKey="pallet" 
    styleClass="p-datatable-gridlines p-datatable-sm"
    [resizableColumns]="true"
    [reorderableColumns]="true"
    columnResizeMode="expand"
    responsiveLayout="scroll"
    [rowHover]="true"
    [scrollable]="true"
    scrollHeight="50rem"
    [loading]="loading">
    <!--Header-->
    <ng-template pTemplate="header">
        <tr>
            <th class="text-center" style="width: 4rem"><p-checkbox (click)="selectAllPallets()"></p-checkbox></th>
            <th class="text-center" style="width: 5rem"></th>
            <th class="text-center">#</th>
            <th class="text-center"> Pallet <p-columnFilter type="text" field="pallet" display="menu"></p-columnFilter></th>
            <th class="text-center"> Id Cliente <p-columnFilter type="text" field="client_Id" display="menu"></p-columnFilter></th>
            <th class="text-center"> Cliente <p-columnFilter type="text" field="client" display="menu"></p-columnFilter></th>
            <th class="text-center"> Item <p-columnFilter type="text" field="item" display="menu"></p-columnFilter></th>
            <th class="text-center"> Referencia <p-columnFilter type="text" field="reference" display="menu"></p-columnFilter></th>
            <th class="text-center"> Cantidad <p-columnFilter type="text" field="qty" display="menu"></p-columnFilter></th>
            <th class="text-center"> Presentación <p-columnFilter type="text" field="presentation" display="menu"></p-columnFilter></th>
            <th class="text-center"> Rollos Disponibles <p-columnFilter type="text" field="qtyRolls" display="menu"></p-columnFilter></th>
        </tr>
    </ng-template>
    <!--Body-->
    <ng-template pTemplate="body" let-pallet let-rowIndex="rowIndex" let-expanded="expanded">
        <tr>
            <td class="text-center"><p-checkbox (click)="selectPallet(pallet)"></p-checkbox></td>
            <td class="text-center">
                <button type="button" pButton pRipple [pRowToggler]="pallet" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            </td>
            <td class="text-center">{{ rowIndex + 1 }}</td>
            <td class="text-center">{{ pallet.pallet }}</td>
            <td class="text-center">{{ pallet.client_Id }}</td>
            <td class="text-center">{{ pallet.client }}</td>
            <td class="text-center">{{ pallet.item }}</td>
            <td class="text-center">{{ pallet.reference }}</td>
            <td class="text-center">{{ qtyPallets(pallet.pallet, rowIndex) | number : '1.2-2' }}</td>
            <td class="text-center">{{ pallet.presentation }}</td>
            <td class="text-center">{{ qtyRollsAvailables(rowIndex) }}</td>
        </tr>
    </ng-template>
    <!--Expansion-->
    <ng-template pTemplate="rowexpansion" let-pallet>
        <tr>
            <td colspan="11">
                <div class="p-3">
                    <p-table
                      #tRowExp1 
                      [value]="pallet.rolls" 
                      dataKey="roll_BagPro"
                      [scrollable]="true"
                      scrollHeight="30rem">
                        <ng-template pTemplate="header">
                            <tr>
                              <th></th>
                              <th></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'roll_BagPro', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'ot', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'item', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'reference', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'qty', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'presentation', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'process', tRowExp1)"></th>
                            </tr>
                            <tr>
                                <th></th>
                                <th class="text-center" pSortableColumn="">#</th>
                                <th class="text-center" pSortableColumn="roll_BagPro">Numero Rollo <p-sortIcon field="roll_BagPro"></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="ot">OT <p-sortIcon field="ot"></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="item">Item <p-sortIcon field="item"></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="reference">Referencia <p-sortIcon field="reference"></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="qty">Cantidad <p-sortIcon field="qty"></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="presentation">Presentación <p-sortIcon field="presentation"></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="process">Proceso <p-sortIcon field="process"></p-sortIcon></th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-roll let-rowIndex="rowIndex">
                            <tr>  
                                <td class="text-center">
                                  <p-checkbox (click)="selectRoll(roll, rowIndex)" [binary]="true" inputId="binary"></p-checkbox>
                                </td>
                                <td class="text-center">{{ rowIndex + 1 }}</td>
                                <td class="text-center">{{ roll.roll_BagPro }}</td>
                                <td class="text-center">{{ roll.ot }}</td>
                                <td class="text-center">{{ roll.item }}</td>
                                <td class="text-center">{{ roll.reference }}</td>
                                <td class="text-center">{{ roll.qty | number : '1.2-2' }}</td>
                                <td class="text-center">{{ roll.presentation }}</td>
                                <td class="text-center">{{ roll.process }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="9">No hay rollos disponibles</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </td>
        </tr>
    </ng-template>
    <!--Footer-->
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="2" class="text-right">Seleccionar:</td>
        <td class="text-center"><p-button icon="pi pi-filter" [rounded]="true" severity="success" (onClick)="selectByFilter()" pTooltip="Seleccionar todo o seleccionar por la información filtrada"></p-button></td>
        <td class="text-center">
          <div class="p-inputgroup justify-content-center">
            <p-inputNumber [(ngModel)]="selectedQty" type="number" [minFractionDigits]="2" [maxFractionDigits]="2" mode="decimal" [useGrouping]="true" (keyup.enter)="selectByQuantity()"></p-inputNumber>
            <span class="p-inputgroup-addon cursor" pTooltip="filtrar por cantidad" tooltipPosition="top" (click)="selectByQuantity()">
              <i class="pi pi-search"></i>
            </span>
          </div>
        </td>
        <td class="text-center"></td> 
        <td colspan="3" class="text-right">Total cantidad: </td>
        <td class="text-center">{{totalQtyByItem() | number : '1.2-2'}}</td>
        <td class="text-right">Total rollos: </td>
        <td class="text-center">{{totalRollsAvailables()}}</td>
      </tr>
    </ng-template>
  </p-table>

  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-box"></i> Pallets/Rollos Seleccionados.</h4>
  </div>

  <!--Pallets seleccionados-->
  <p-table 
    #t2
    [value]="selectedPallets"
    dataKey="pallet" 
    styleClass="p-datatable-gridlines p-datatable-sm"
    [resizableColumns]="true"
    [reorderableColumns]="true"
    columnResizeMode="expand"
    [rowHover]="true"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="50rem"
    *ngIf="!load">
    <!--Header-->
    <ng-template pTemplate="header">
        <tr>
            <th class="text-center" style="width: 4rem"><p-checkbox (click)="deselectAllPallets()"></p-checkbox></th>
            <th class="text-center" style="width: 5rem"></th>
            <th class="text-center">#</th>
            <th class="text-center"> Pallet <p-columnFilter type="text" field="pallet" display="menu"></p-columnFilter></th>
            <th class="text-center"> Id Cliente <p-columnFilter type="text" field="client_Id" display="menu"></p-columnFilter></th>
            <th class="text-center"> Cliente <p-columnFilter type="text" field="client" display="menu"></p-columnFilter></th>
            <th class="text-center"> Item <p-columnFilter type="text" field="item" display="menu"></p-columnFilter></th>
            <th class="text-center"> Referencia <p-columnFilter type="text" field="reference" display="menu"></p-columnFilter></th>
            <th class="text-center"> Cantidad <p-columnFilter type="text" field="" display="menu"></p-columnFilter></th>
            <th class="text-center"> Presentación <p-columnFilter type="text" field="presentation" display="menu"></p-columnFilter></th>
            <th class="text-center"> Rollos Seleccionados <p-columnFilter type="text" field="" display="menu"></p-columnFilter></th>
        </tr>
    </ng-template>
    <!--Body-->
    <ng-template pTemplate="body" let-pallet let-rowIndex="rowIndex" let-expanded="expanded">
        <tr>
            <td class="text-center"><p-checkbox (click)="deselectPallet(pallet)"></p-checkbox></td>
            <td class="text-center">
                <button type="button" pButton pRipple [pRowToggler]="pallet" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            </td>
            <td class="text-center">{{ rowIndex + 1 }}</td>
            <td class="text-center">{{ pallet.pallet }}</td>
            <td class="text-center">{{ pallet.client_Id }}</td>
            <td class="text-center">{{ pallet.client }}</td>
            <td class="text-center">{{ pallet.item }}</td>
            <td class="text-center">{{ pallet.reference }}</td>
            <td class="text-center">{{ qtySelectedPallets(pallet.pallet, rowIndex) | number : '1.2-2' }}</td>
            <td class="text-center">{{ pallet.presentation }}</td>
            <td class="text-center">{{ qtySelectedRolls(rowIndex) }}</td>
        </tr>
    </ng-template>
    <!--Expansion-->
    <ng-template pTemplate="rowexpansion" let-pallet>
        <tr>
            <td colspan="11">
                <div class="p-3">
                    <p-table 
                      #tRowExp2
                      [value]="pallet.rolls" 
                      dataKey="roll_BagPro"
                      [scrollable]="true"
                      scrollHeight="30rem">
                        <ng-template pTemplate="header">
                            <tr>
                              <th></th>
                              <th></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'roll_BagPro', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'ot', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'item', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'reference', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'qty', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'presentation', tRowExp1)"></th>
                              <th><input pInputText style="width: 100%;" (input)="applyFilter($event, 'process', tRowExp1)"></th>
                            </tr>
                            <tr>
                                <th class="text-center"></th>
                                <th class="text-center" pSortableColumn="">#</th>
                                <th class="text-center" pSortableColumn="">Numero Rollo <p-sortIcon field=""></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="">OT <p-sortIcon field=""></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="">Item <p-sortIcon field=""></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="">Referencia <p-sortIcon field=""></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="">Cantidad <p-sortIcon field=""></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="">Presentación <p-sortIcon field=""></p-sortIcon></th>
                                <th class="text-center" pSortableColumn="">Proceso <p-sortIcon field=""></p-sortIcon></th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-roll let-rowIndex="rowIndex">
                            <tr>  
                                <td class="text-center">
                                  <p-checkbox (click)="deselectRoll(roll, rowIndex)" [binary]="true" inputId="binary"></p-checkbox>
                                </td>
                                <td class="text-center">{{ rowIndex + 1 }}</td>
                                <td class="text-center">{{ roll.roll_BagPro }}</td>
                                <td class="text-center">{{ roll.ot }}</td>
                                <td class="text-center">{{ roll.item }}</td>
                                <td>{{ roll.reference }}</td>
                                <td class="text-center">{{ roll.qty | number : '1.2-2'}}</td>
                                <td class="text-center">{{ roll.presentation }}</td>
                                <td class="text-center">{{ roll.process }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="9">No hay rollos disponibles</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </td>
        </tr>
    </ng-template>
    <!--Footer-->
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="2" class="text-right">Seleccionar:</td>
        <td class="text-center"><p-button icon="pi pi-filter" [rounded]="true" severity="success" (onClick)="deselectByFilter()" pTooltip="Seleccionar todo o seleccionar por la información filtrada"></p-button></td>
        <td colspan="9"></td>
      </tr>
    </ng-template>    
  </p-table>

  <p-divider></p-divider>

  <!--Botones-->
  <div class="d-grid gap-2 d-md-flex justify-content-md-center">
    <button pButton class="p-button-danger" type="button" label="Crear Orden" icon="pi pi-send" [disabled]="load || selectedPallets.length == 0" (click)="validateInformation()"></button>
    <button pButton class="p-button-secondary" type="button" label="Limpiar Campos" icon="pi pi-eraser" [disabled]="load" (click)="clearFields()"></button>
  </div>

</p-card>

