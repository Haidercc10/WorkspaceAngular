
<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <!-- Navegador fin de parte superior -->
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo': !modoSeleccionado, 'tituloClaro': modoSeleccionado}">Reposiciones</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<!--* Modulo-->
<p-card>

  <div class="mb-3">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-search"></i> Consultar rollos/bultos</h4>
  </div>

  <!--* Nota-->
  <div class="mb-5">
    Los campos marcados con (*) son obligatorios para realizar la consulta.
  </div>
  
  <!--* Formulario-->
  <form [formGroup]="form">
    <div class="mb-4" id="">
      <div class="row g-4">

        <!--* Cliente -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-4">
          <span class="p-input-icon-left p-float-label">
            <i class="pi pi-search"></i>
            <input formControlName="client" id="client" list="list" type="text" pInputText required (keyup)="searchClientsByName()" (change)="selectClient()"/>
            <datalist id="list">
              <option value={{item.idcliente}} *ngFor="let item of clients">{{item.razoncial}}</option>
            </datalist>
            <label for="client">Cliente*</label>
          </span>
        </div>

        <!--* Rollo -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-2 col-xxl-2">
          <span class="p-input-icon-left p-float-label">
            <i class="pi pi-search"></i>
            <input pInputText formControlName="roll" inputId="roll" autocomplete="off" type="number" (keyup.enter)="searchRolls()"/>
            <label for="roll">Rollo/Bulto*</label>
          </span>
        </div>

        <!--! Proceso-->
        <!--div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-2 col-xxl-2 justify-content-md-center">
          <div div class="field-checkbox my-2 mx-4">
            <p-triStateCheckbox formControlName="process" [(ngModel)]="searchIn" inputId="tricheckbox"></p-triStateCheckbox>
            <label class="p-tristatecheckbox-label" for="tricheckbox">
              <p-chip [label]="searchIn == null ? 'Tipo: SELLADO' : searchIn ? 'Tipo: EMPAQUE' : 'Tipo: EXTRUSIÓN'"
                      [icon]="searchIn == null ? 'pi pi-database' : searchIn ? 'pi pi-box' : 'pi pi-bolt'"></p-chip>
            </label>
          </div>
        </div>-->

        <!--! Item -->
        <!--<div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-2 col-xxl-2">
          <span class="p-input-icon-left p-float-label">
            <i class="pi pi-search"></i>
            <input pInputText formControlName="item" inputId="item" autocomplete="off" type="number" (keyup.enter)="getItem()"/>
            <label for="item">Item*</label>
          </span>
        </div>-->

        <!--! Referencia -->
        <!--<div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-4">
          <span class="p-input-icon-left p-float-label">
            <i class="pi pi-search"></i>
            <input formControlName="reference" id="prod" list="producto" type="text" pInputText (change)="selectedProduct()" (keydown)="searchProduct()"/>
            <datalist id="producto">
              <option value={{item.prod_Id}} *ngFor="let item of products">{{item.prod_Nombre}}</option>
            </datalist>
            <label for="prod">Producto*</label>
          </span>
        </div>-->

        <!--* Observación -->
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 col-xl-6 col-xxl-6">
          <span class="p-float-label">
            <textarea formControlName="observation" [rows]="1" inputId="observation" pInputTextarea></textarea>
            <label for="observation">Observación</label>
          </span>
        </div>

      </div>
    </div>

    <!--* Botones 1-->
    <div class="mb-3">
      <div class="row g-3">
        <div class="d-grid gap-3 d-md-flex justify-content-md-center">
          <button pButton pRipple class="p-button-secondary" icon="pi pi-eraser" type="button" label="Limpiar campos" (click)="clearFields()" id="botones1"></button>
          <button pButton pRipple class="p-button-outlined p-button-secondary" type="button" icon="pi pi-eraser" (click)="clearAll()" label="Limpiar todo" id="botones1"></button>
        </div>
      </div>
    </div>
  </form>

  <!--* Linea 1 -->
  <div class="mb-4">
    <hr class="Linea">
  </div>

  <!--* Titulo Items -->
  <div class="mb-4">
    <div class="row g-3">
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-6 col-xl-6 col-xxl-8">
        <h4 [ngClass]="{'tituloRojo': !modoSeleccionado, 'tituloClaro': modoSeleccionado}"><i class="pi pi-list"></i> Tabla de referencias consolidadas</h4>
      </div>
    </div>
  </div>

  <!--* Tabla Items -->
  <div class="mb-3">
    <div class="row g-3 font-size-14" id="tabla1">
      <p-table
          #dt1
          [value]="rollsConsolidate"
          styleClass="p-datatable-sm p-datatable-gridlines"
          responsiveLayout="scroll"
          [rowHover]="true"
          dataKey="0"
          [scrollable]="true"
          scrollHeight="50rem"
          [resizableColumns]="true"
          columnResizeMode="expand"
          *ngIf="!load">
        <ng-template pTemplate="header">
          <tr>
            <th></th>
            <th class="text-center" colspan="2">Información Producto</th>
            <th class="text-center" colspan="3">Información Cantidades</th>
            <th class="text-center" colspan="2">Información Peso</th>
          </tr>
          <tr>
            <th class="text-center">#</th>
            <th class="text-center" scope="col">Item </th>
            <th class="text-center" scope="col">Referencia</th>
            <th class="text-center" scope="col">Cant/Peso Neto</th>
            <th class="text-center" scope="col">Presentación</th>
            <th class="text-center" scope="col">Cant. Rollos</th>
            <th class="text-center" scope="col">Peso Bruto</th>
            <th class="text-center" scope="col">Unidad</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
          <tr>
            <td>{{rowIndex + 1}}</td>
            <td class="text-center"><b>{{data.item}}</b></td>
            <td class="text-center">{{data.reference}}</td>
            <td class="text-center textBlue"><b>{{qtyTotalItem(data) | number : '1.2-2'}}</b></td>
            <td class="text-center">{{data.unit}}</td>
            <td class="text-center">{{qtyRollsItem(data)}}</td>
            <td class="text-center textOrange"><b>{{ weightTotalItem(data) | number : '1.2-2'}}</b></td>
            <td class="text-center">{{'Kg'}}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!--* Linea 2  -->
  <div class="mb-5">
    <hr class="Linea">
  </div>

   <!--* titulo tabla rollos -->
   <div class="mb-4">
    <div class="row g-3">
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-6 col-xl-6 col-xxl-8">
        <h4 [ngClass]="{'tituloRojo': !modoSeleccionado, 'tituloClaro': modoSeleccionado}"><i class="pi pi-list"></i> Tabla de rollos agregados</h4>
      </div>
    </div>
  </div>

  <!--* Tabla de rollos-->
  <div class="mb-4">
    <p-table
      #dt
      *ngIf="!load"
      [value]="rollsToDispatch"
      styleClass="p-datatable-sm"
      responsiveLayout="scroll"
      [resizableColumns]="true"
      columnResizeMode="expand"
      [rowHover]="true"
      [scrollable]="true"
      scrollHeight="50rem">
        <ng-template pTemplate="header">
          <tr>
            <th></th>
            <th><input pInputText type="number" style="width: 100%;" (input)="applyFilter($event, 'roll', dt)"></th>
            <th><input pInputText type="number" style="width: 100%;" (input)="applyFilter($event, 'ot', dt)"></th>
            <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'client', dt)"></th>
            <th><input pInputText type="number" style="width: 100%;" (input)="applyFilter($event, 'item', dt)"></th>
            <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'reference', dt)"></th>
            <th><input pInputText type="number" style="width: 100%;" (input)="applyFilter($event, 'qty', dt)"></th>
            <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'unit', dt)"></th>
            <th><input pInputText type="text" style="width: 100%;" (input)="applyFilter($event, 'process', dt)"></th>
            <th></th>
          </tr>
          <tr>
            <th class="text-center">#</th>
            <th class="text-center">Rollo</th>
            <th class="text-center">OT</th>
            <th class="text-center">Cliente</th>
            <th class="text-center">Item</th>
            <th class="text-center">Referencia</th>
            <th class="text-center">Peso</th>
            <th class="text-center">Unidad</th>
            <th class="text-center">Proceso</th>
            <th class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">Quitar</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
          <tr>
            <td class="text-center">{{(rollsToDispatch.length - 1) - rowIndex + 1}}</td>
            <td class="text-center"><b>{{data.roll}}</b></td>
            <td class="text-center">{{data.ot}}</td>
            <td>{{data.client}}</td>
            <td class="text-center">{{data.item}}</td>
            <td><b>{{data.reference}}</b></td>
            <td class="text-center textBlue"><b>{{data.qty | number : '1.2-2'}}</b></td>
            <td class="text-center"><b>{{data.unit}}</b></td>
            <td class="text-center">
              <span class="badge" 
              [ngClass]="{'bg-Extrusion': data.process == 'Extrusion',
              'bg-Sellado': data.process == 'Sellado',
              'bg-Empaque': data.process == 'Empaque', }">{{data.process}}</span>
            </td>
            <td class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">
              <p-button icon="pi pi-trash" [rounded]="true" (click)="quitRoll(data)" severity="danger"></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="10"><h6><b>No hay rollos agregados.</b></h6></td>
          </tr>
        </ng-template>
    </p-table>
  </div>

  <!--* Botones -->
  <div *ngIf="!load">
    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
      <button pButton class="p-button-danger" id="ingresarRollo" [disabled]="rollsToDispatch.length == 0" type="button" label="Generar Reposición" icon="pi pi-check" (click)="saveReposition()"></button>
      <button pButton class="p-button-secondary" id="limpiarTodo" type="button" label="Limpiar todo" icon="pi pi-eraser" (click)="clearAll()"></button>
    </div>
  </div>

</p-card>