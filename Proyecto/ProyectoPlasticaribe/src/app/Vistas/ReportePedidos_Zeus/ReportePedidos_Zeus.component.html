<app-menuLateral></app-menuLateral>

<div class="d-flex justify-content-center overlay" *ngIf="cargando">
  <div class="spinner-border text-danger" role="status" style="margin: auto;">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>

<div class="contain">
  <!-- Navegador fin de parte superior -->
  <div class="container-fluid">
    <!-- principal -->
    <div class="mb-4 Titulo">
      <h2 class="tituloRojo">Pedidos de Productos</h2>
    </div>

    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<!-- Tabla de Pedidos -->
<div class="container-fluid">
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <button pButton pRipple label="Exportar Excel" icon="pi pi-file-excel" class="p-button-success r-2" (click)="exportarExcel()"></button>
  </div>
  <div class="mb-4">
    <h3 class="tituloRojo">Información de Pedidos</h3>
  </div>
  <div *ngIf="!cargando" id="tableProcesos" style="font-size: 14px;">
    <div class="mb-4 ">
      <div class="row g-3">
        <p-table
          #dt
          [columns]="columnasSeleccionada"
          [value]="ArrayDocumento"
          [resizableColumns]="true"
          columnResizeMode="expand"
          styleClass="p-datatable-gridlines p-datatable-sm"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="ArrayDocumento.length"
          [showCurrentPageReport]="true"
          [(first)]="first"
          currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros"
          [rowsPerPageOptions]="[10,20,30,50,70,100, ArrayDocumento.length]"
          [rowHover]="true"
          dataKey="id">
          <!-- Columnas Seleccionables -->
          <ng-template pTemplate="caption">
            <p-multiSelect
              [options]="columnas"
              [(ngModel)]="columnasSeleccionada"
              optionLabel="header"
              selectedItemsLabel="{0} columnas seleccionadas"
              [style]="{minWidth: '300px'}"
              placeholder="Elige las columnas que quieres ver"></p-multiSelect>
          </ng-template>
          <!-- Columnas Principales -->
          <ng-template pTemplate="header" let-columns>
            <!-- Campo de Busqueda -->
            <tr title="Filtros para realizar busquedas de cada campo">
              <th>
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'cliente', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'producto', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'cant_Pedida', 'contains')" class="w-full">
              </th>
                <th>
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'cant_Pendiente', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'cant_Facturada', 'contains')" class="w-full">
              </th>
                <th>
                  <input pInputText type="number" style="width: 100%;" (input)="aplicarfiltro($event, 'existencias', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'presentacion', 'contains')" class="w-full">
              </th>
              <th>
                <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'estado', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'vendedor', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'OT', 'contains')" class="w-full">
              </th>
              <th>
                <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'Proceso_OT', 'contains')" class="w-full">
              </th>
              <th>
                  <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'costo_Cant_Pendiente', 'contains')" class="w-full">
              </th>
              <th>
                <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'costo_Cant_Total', 'contains')" class="w-full">
              </th>
              <th *ngFor="let col of columns">
                <input pInputText type="{{col.type}}" style="width: 100%;" (input)="aplicarfiltro($event, col.field, 'contains')" class="w-full">
              </th>
              <th>
                <input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')" class="w-full">
              </th>
            </tr>

            <tr>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="consecutivo">Pedido
                <p-sortIcon field="consecutivo"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="cliente">Cliente
                <p-sortIcon field="cliente"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="producto">Producto
                <p-sortIcon field="producto"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="cant_Pedida" title="Cantidad Pedida">Cant. Pedida
                <p-sortIcon field="cant_Pedida"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="cant_Pendiente" title="Cantidad Pendiente">Pendiente
                <p-sortIcon field="cant_Pendiente"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="cant_Facturada" title="Cantidad Facturada">Facturada
                <p-sortIcon field="cant_Facturada"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="existencias">Stock
                <p-sortIcon field="existencias"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="presentacion">Und
                <p-sortIcon field="presentacion"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="estado">Estado
                <p-sortIcon field="estado"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="vendedor">Vendedor
                <p-sortIcon field="vendedor"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="OT">OT
                <p-sortIcon field="OT"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="Proceso_OT">Proceso Actual
                <p-sortIcon field="Proceso_OT"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="costo_Cant_Pendiente">Total Pendiente
                <p-sortIcon field="costo_Cant_Pendiente"></p-sortIcon>
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col" pSortableColumn="costo_Cant_Total">Total
                <p-sortIcon field="costo_Cant_Total"></p-sortIcon>
              </th>
              <th *ngFor="let col of columns" style="font-size: 14px;">
                {{col.header}}
              </th>
              <th style="text-align: center; font-size: 14px;" scope="col">Ver PDF</th>
            </tr>
          </ng-template>

          <!-- Cuerpo de la tabla -->
          <ng-template pTemplate="body" let-data let-columns="columns">
            <tr style="cursor: pointer;" title="Con la tecla shift y el scroll del mouse puede moverse hacia los lados de la tabla">
              <td style="text-align: center;" scope="col" title="N° Pedido" (dblclick)="varOrdenTranajo(data)">{{data.consecutivo}}</td>
              <td scope="col" title="Cliente" (dblclick)="varOrdenTranajo(data)">{{data.cliente}}</td>
              <td scope="col" title="Item" (dblclick)="varOrdenTranajo(data)">{{data.producto}}</td>
              <td style="text-align: center;" scope="col" title="Cantidad Pedida" (dblclick)="varOrdenTranajo(data)">{{data.cant_Pedida | number : '1.2-2'}}</td>
              <td style="text-align: center;" scope="col" title="Cantidad Pendiente" class="bg-danger2" (dblclick)="varOrdenTranajo(data)"><b>{{data.cant_Pendiente | number : '1.2-2'}}</b></td>
              <td style="text-align: center;" scope="col" title="Cantidad Facturada" (dblclick)="varOrdenTranajo(data)">{{data.cant_Facturada | number : '1.2-2'}}</td>
              <td style="text-align: center;" scope="col" title="Existencias" (dblclick)="varOrdenTranajo(data)">{{data.existencias | number : '1.2-2'}}</td>
              <td style="text-align: center;" scope="col" title="Presentación" (dblclick)="varOrdenTranajo(data)">{{data.presentacion}}</td>
              <ng-container *ngIf="data.estado == 'Pendiente'">
                <td style="text-align: center;" scope="col" title="{{titlePendiente}}." data-bs-toggle="modal" data-bs-target="#modalEstados" (click)="varOrdenTranajo(data)"><span class="badge bg-danger1">{{data.estado}}</span></td>
              </ng-container>
              <ng-container *ngIf="data.estado == 'Parcialmente Satisfecho'">
                <td style="text-align: center;" scope="col" title="{{titleParcial}}" data-bs-toggle="modal" data-bs-target="#modalEstados" (click)="varOrdenTranajo(data)"><span class="badge bg-warning1">{{data.estado}}</span></td>
              </ng-container>
              <td scope="col" title="Vendedor">{{data.vendedor}}</td>
              <td style="text-align: center;" scope="col" pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <input class="form-control form-control-sm" style="width: 100px;" type="number" [(ngModel)]="data.OT" (keyup.space)="cambiarOrden_Pedido(data)">
                  </ng-template>
                  <ng-template pTemplate="output">
                    <span class="badge verde" *ngIf="data.Estado_OT == 17">{{data.OT}}</span> <!-- Terminada -->
                    <span class="badge verde2" *ngIf="data.Estado_OT == 18">{{data.OT}}</span> <!-- Cerrada -->
                    <span class="badge rojo" *ngIf="data.Estado_OT == 3">{{data.OT}}</span> <!-- Anulada -->
                    <span class="badge azul" *ngIf="data.Estado_OT == 14">{{data.OT}}</span> <!-- Asignada -->
                    <span class="badge amarillo" *ngIf="data.Estado_OT == 16">{{data.OT}}</span> <!-- En Proceso -->
                    <span class="badge naranja" *ngIf="data.Estado_OT == 15">{{data.OT}}</span> <!-- Abierta -->
                  </ng-template>
                </p-cellEditor>
              </td>
              <td style="text-align: center;" scope="col" (dblclick)="varOrdenTranajo(data)">
                <span class="badge verde" *ngIf="data.CantPesada >= data.CantPedidaKg_OT || data.Proceso_OT >= data.CantPedidaUnd_OT">{{data.Proceso_OT}}</span> <!-- Terminada -->
                <span class="badge amarillo" *ngIf="(data.CantPesada < data.CantPedidaKg_OT || data.Proceso_OT < data.CantPedidaUnd_OT) && data.CantPesada > 0">{{data.Proceso_OT}}</span> <!-- En Proceso -->
              </td>
              <td style="text-align: center;" scope="col" title="N° Pedido" (dblclick)="varOrdenTranajo(data)">{{data.costo_Cant_Pendiente}}</td>
              <td style="text-align: center;" scope="col" title="N° Pedido" (dblclick)="varOrdenTranajo(data)">{{data.costo_Cant_Total}}</td>
              <td *ngFor="let col of columns">{{data[col.field]}}</td>
              <td style="text-align: center;" scope="col" title="Ver detalle del pedido"><button pButton pRipple (click)="mostrarPedidoPdf(data)" icon="pi pi-eye" class="p-button-rounded p-button-success mr-2" style="width: 30px; height: 30px;"></button></td>
            </tr>
          </ng-template>

          <!-- Footer de la Tabla -->
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="12" class="text-right">Totales</td>
            <td>{{sumaCostoPendiente | number : '1.2-2'}}</td>
            <td>{{sumaCostoTotal | number : '1.2-2'}}</td>
            <td>COP</td>
          </tr>
        </ng-template>

          <ng-template pTemplate="summary">
            <div class="p-d-flex p-ai-center p-jc-between">
              En total hay {{ArrayDocumento ? ArrayDocumento.length : 0 | number : '1.2-2'}} Pedido(s).
            </div>
          </ng-template>
        </p-table>

      </div>
    </div>
  </div>
</div>

<!-- Model que mostrará la información de las ordenes de trabajo con un estado especifico -->
<p-dialog [(visible)]="modalEstadosOrdenes" [style]="{width: '1800px'}" [breakpoints]="{'960px': '75vw', '640px': '100vw'}" header="Estados de la orden de trabajo del pedido {{consecutivoPedido}}" [modal]="true" styleClass="p-fluid">
  <ng-template pTemplate="content">
    <app-Reporte_Procesos_OT></app-Reporte_Procesos_OT>
  </ng-template>
</p-dialog>
