<app-menuLateral></app-menuLateral>

<div class="d-flex justify-content-center overlay" *ngIf="cargando">
  <div class="spinner-border text-danger" role="status" style="margin: auto;">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>

<div class="contain">
  <!-- Navegador fin de parte superior -->
  <div class="container-fluid">
    <!-- principal -->
    <div class="mb-4 Titulo">
      <h2 class="tituloRojo">Pedidos de Productos</h2>
    </div>

    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<!-- Tabla de Pedidos -->
<div class="container-fluid">
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <button pButton pRipple label="Exportar Excel" icon="pi pi-file-excel" class="p-button-success r-2" (click)="exportarExcel()"></button>
  </div>
  <div class="mb-4">
    <h3 class="tituloRojo">Información de Pedidos</h3>
  </div>
  <div *ngIf="!cargando" id="tableProcesos" style="font-size: 14px;">
    <div class="mb-4 ">
      <div class="row g-3">
        <p-treeTable #tt
         [value]="ArrayDocumento"
         [columns]="columnasSeleccionada"
         [resizableColumns]="true"
         columnResizeMode="expand"
         styleClass="p-datatable-gridlines p-datatable-sm"
         responsiveLayout="scroll"
         [paginator]="true"
         [rows]="ArrayDocumento.length"
         [showCurrentPageReport]="true"
         currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros"
         [rowsPerPageOptions]="[10,20,30,50,70,100, ArrayDocumento.length]"
         [rowHover]="true">
         <ng-template pTemplate="caption">
             <div style="text-align:left">
                 <p-multiSelect [options]="columnas" [(ngModel)]="columnasSeleccionada" optionLabel="header"
                    selectedItemsLabel="{0} columns selected" [style]="{'width': '20em'}" defaultLabel="Choose Columns"></p-multiSelect>
             </div>
         </ng-template>
          <ng-template pTemplate="header" let-columns>
            <tr>
              <th style="text-align: center; font-size: 14px;" scope="col">Pedido</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Cliente</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Producto</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Cant. Pedida</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Pendiente</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Facturada</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Stock</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Und</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Estado</th>
              <th style="text-align: center; font-size: 14px;" scope="col">Vendedor</th>
              <th style="text-align: center; font-size: 14px;" scope="col">OT</th>
              <th *ngFor="let col of columnasSeleccionada"> {{col.header}} </th>
            </tr>
            <!-- <tr>
              <th *ngFor="let col of columnas">
                <input pInputText type="text" >
              </th>
            </tr> -->
          </ng-template>
          <ng-template pTemplate="body" let-rowNode let-data="rowData">
            <tr>
              <td style="text-align: center;" scope="col" title="N° Pedido" (dblclick)="varOrdenTranajo(data)">
                <p-treeTableToggler [rowNode]="rowNode" ></p-treeTableToggler>
                {{data.consecutivo}}
              </td>
              <td scope="col" title="Cliente" (dblclick)="varOrdenTranajo(data)">{{data.cliente}}</td>
              <td scope="col" title="Item" (dblclick)="varOrdenTranajo(data)">{{data.producto}}</td>
              <td style="text-align: center;" scope="col" title="Cantidad Pedida" (dblclick)="varOrdenTranajo(data)">{{data.cant_Pedida | number : '1.2-2'}}</td>
              <td style="text-align: center;" scope="col" title="Cantidad Pendiente" class="bg-danger2" (dblclick)="varOrdenTranajo(data)"><b>{{data.cant_Pendiente | number : '1.2-2'}}</b></td>
              <td style="text-align: center;" scope="col" title="Cantidad Facturada" (dblclick)="varOrdenTranajo(data)">{{data.cant_Facturada | number : '1.2-2'}}</td>
              <td style="text-align: center;" scope="col" title="Existencias" (dblclick)="varOrdenTranajo(data)">{{data.existencias | number : '1.2-2'}}</td>
              <td style="text-align: center;" scope="col" title="Presentación" (dblclick)="varOrdenTranajo(data)">{{data.presentacion}}</td>
              <ng-container *ngIf="data.estado == 'Pendiente'">
                <td style="text-align: center;" scope="col" title="{{titlePendiente}}." data-bs-toggle="modal" data-bs-target="#modalEstados" (click)="varOrdenTranajo(data)"><span class="badge bg-danger1">{{data.estado}}</span></td>
              </ng-container>
              <ng-container *ngIf="data.estado == 'Parcialmente Satisfecho'">
                <td style="text-align: center;" scope="col" title="{{titleParcial}}" data-bs-toggle="modal" data-bs-target="#modalEstados" (click)="varOrdenTranajo(data)"><span class="badge bg-warning1">{{data.estado}}</span></td>
              </ng-container>
              <td scope="col" title="Vendedor">{{data.vendedor}}</td>
              <td ttEditableColumn>
                <p-treeTableCellEditor>
                  <ng-template pTemplate="input">
                      <input pInputText type="text" [(ngModel)]="data.OT">
                  </ng-template>
                  <ng-template pTemplate="output">
                    <span class="badge verde" *ngIf="data.Estado_OT == 17">{{data.OT}}</span> <!-- Terminada -->
                    <span class="badge verde2" *ngIf="data.Estado_OT == 18">{{data.OT}}</span> <!-- Cerrada -->
                    <span class="badge rojo" *ngIf="data.Estado_OT == 3">{{data.OT}}</span> <!-- Anulada -->
                    <span class="badge azul" *ngIf="data.Estado_OT == 14">{{data.OT}}</span> <!-- Asignada -->
                    <span class="badge amarillo" *ngIf="data.Estado_OT == 16">{{data.OT}}</span> <!-- En Proceso -->
                    <span class="badge naranja" *ngIf="data.Estado_OT == 15">{{data.OT}}</span> <!-- Abierta -->
                  </ng-template>
                </p-treeTableCellEditor>
              </td>

              <td *ngFor="let col of columnasSeleccionada; let i = index"> {{data[col.field]}} </td>
            </tr>
          </ng-template>
        </p-treeTable>

      </div>
    </div>
  </div>
</div>

<!-- Model que mostrará la información de las ordenes de trabajo con un estado especifico -->
<p-dialog [(visible)]="modalEstadosOrdenes" [style]="{width: '1800px'}" [breakpoints]="{'960px': '75vw', '640px': '100vw'}" header="Estados de la orden de trabajo del pedido {{consecutivoPedido}}" [modal]="true" styleClass="p-fluid">
  <ng-template pTemplate="content">
    <app-Reporte_Procesos_OT></app-Reporte_Procesos_OT>
  </ng-template>
</p-dialog>
