<!--Navegador parte superior -->
<div class="d-flex justify-content-center overlay" *ngIf="cargando">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Desperdicio {{area.nombre != 'NO APLICA' ? area.nombre : ''}}</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="d-grid gap-2 d-md-flex justify-content-md-end" >
    <p-button icon="pi pi-info" styleClass="p-button-rounded p-button-warning" [style]="{width: '25px', height: '25px'}" (click)="tutorial()" pTooltip="Ver Tutorial" tooltipPosition="top"></p-button>
  </div>

  <div class="mb-5">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-cloud-download"></i>  Registro de Desperdicio</h4>
  </div> 

  <!-- Formulario del pedido de mantenimiento -->
  <form [formGroup]="FormDesperdicio">
    <div class="mb-3" id="formulario">
      <div class="row g-4">

        <!-- OT -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1" id="ordenTrabajo">
          <span class="p-float-label">
            <p-inputNumber formControlName="OTDesperdicio" id="ordenTrabajo" type="text" [autofocus]="true" [useGrouping]="false" (keyup.enter)="consultarOrdenTrabajo()"></p-inputNumber>
            <label for="ordenTrabajo">OT</label>
          </span>
        </div>

        <!-- TIPO DE MATERIAL -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl" id="material">
          <span class="p-float-label">
            <p-dropdown formControlName="IdTipoMaterial" (onChange)="buscarMaterial()" [options]="materiales" optionLabel="material_Nombre" optionValue="material_Id" [autoDisplayFirst]="false"></p-dropdown>
            <label for="Nombre">Material</label>
          </span>
        </div>

        <!-- IMPRESO -->
        <div class="form-floating col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1" id="impresion">
          <div class="field-radiobutton">
            <p-radioButton formControlName="Impreso" name="Impreso" value="SI" inputId="city1"></p-radioButton>
            <label for="city1">Impreso</label>
          </div>
          <div class="field-radiobutton">
            <p-radioButton formControlName="Impreso" name="Impreso" value="NO" inputId="city2"></p-radioButton>
            <label for="city2">No Impreso</label>
          </div>
        </div>

        <!-- MAQUINA -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1" id="maquina">
          <span class="p-float-label">
            <p-inputNumber formControlName="Maquina" id="Maquina" list="Maquinas" [useGrouping]="false"></p-inputNumber>
            <label for="Maquina">Maquina</label>
          </span>
        </div>

        <!-- OPERARIO -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-2">
          <span class="p-float-label">
              <p-dropdown formControlName="IdOperario" inputId="operario" [autoDisplayFirst]="false" [options]="operarios" optionLabel="usua_Nombre" optionValue="usua_Id" [required]="true" [filter]="true" filterBy="usua_Nombre"></p-dropdown>
              <label for="operario">Operario</label>
          </span>
        </div>

        <!-- NO CONFORMIDAD -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-2">
          <span class="p-float-label">
              <p-dropdown formControlName="IdTipoNoConformidad" inputId="NoConformidad" [autoDisplayFirst]="false" [options]="fallas" optionLabel="falla_Nombre" optionValue="falla_Id" [required]="true" [filter]="true" filterBy="falla_Nombre"></p-dropdown>
              <label for="NoConformidad">No Conformidad</label>
          </span>
        </div>

        <!-- CANTIDAD DE DESPERDICIO -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1" id="cantidad">
          <span class="p-float-label">
            <p-inputNumber formControlName="CantidadKg" id="Cantidad" mode="decimal" [minFractionDigits]="2" [readonly]="true"></p-inputNumber>
            <label for="Cantidad">Cantidad</label>
          </span>
        </div>

        <!-- AREA -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl" id="area">
          <span class="p-float-label">
            <p-dropdown formControlName="IdArea" (onChange)="buscarProceso()" id="Areas" [options]="procesos" optionLabel="proceso_Nombre" [readonly]="this.ValidarRol != 1" optionValue="proceso_Id" [autoDisplayFirst]="false"></p-dropdown>
            <label for="Areas">Area</label>
          </span>
        </div>

         <!-- TURNO -->
         <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-1" id="turno">
          <span class="p-float-label">
            <p-dropdown formControlName="Turno" id="turno" [options]="turnos" optionLabel="turno_Id" [readonly]="true" optionValue="turno_Id" [autoDisplayFirst]="false"></p-dropdown>
            <label for="turno">Turno</label>
          </span>
        </div>

        <!-- OBSERVACION -->
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-12 mb-12 mb-3" id="observacion">
          <span class="p-float-label">
            <textarea formControlName="Observacion" [rows]="1"  maxlength="200" pInputTextarea></textarea>
            <label for="textarea">Observación</label>
          </span>
        </div>
      </div>
    </div>

     <!--Tabla OT-->
     <div class="mb-3">
      <p-table
      #dtOT
      *ngIf="!cargando" 
      styleClass="p-datatable-gridlines"
      [value]="ordenesTrabajo"
      [rowHover]="true">
       <ng-template pTemplate="header">
           <tr>
             <th style="font-weight: 800;" class="text-center" colspan="3">Información General</th>
             <th style="font-weight: 800;" class="text-center" colspan="3">Desperdicio</th>
             <th style="font-weight: 800;" class="text-center" colspan="6">Extrusión</th>
           </tr>
           <tr>
               <th style="font-weight: 600;" class="text-center">Cliente</th>
               <th style="font-weight: 600;" class="text-center">Item</th>
               <th style="font-weight: 600;" class="text-center">Referencia</th>
               <th style="font-weight: 600;" class="text-center">Cantidad</th>
               <th style="font-weight: 600;" class="text-center">Unidad</th>
               <th style="font-weight: 600;" class="text-center">Porcentaje</th>
               <th style="font-weight: 600;" class="text-center">Material</th>
               <th style="font-weight: 600;" class="text-center">Calibre</th>
               <th style="font-weight: 600;" class="text-center">Ancho 1</th>
               <th style="font-weight: 600;" class="text-center">Ancho 2</th>
               <th style="font-weight: 600;" class="text-center">Ancho 3</th>
               <th style="font-weight: 600;" class="text-center">Medida</th>
           </tr>
       </ng-template>
       <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
           <tr>
               <td class="text-center">{{ data.Cliente }}</td>
               <td class="text-center">{{ data.IdProducto }}</td>
               <td class="text-center">{{ data.Producto }}</td>
               <td class="text-center"><b>{{ calcularPeso() | number : '1.2-2' }}</b></td>
               <td class="text-center">{{ data.Unidad }}</td>
               <td class="text-center font-size-15" [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><b>{{ ((calcularPeso() / data.CantKg) * 100) | number : '1.2-2'}} %</b></td>
               <td class="text-center">{{ data.TipoMaterial }}</td>
               <td class="text-center">{{ data.Calibre | number : '1.2-2' }}</td>
               <td class="text-center">{{ data.Ancho1 | number : '1.2-2' }}</td>
               <td class="text-center">{{ data.Ancho2 | number : '1.2-2' }}</td>
               <td class="text-center">{{ data.Ancho3 | number : '1.2-2' }}</td>
               <td class="text-center">{{ data.Unidad_Extrusion }}</td>
           </tr>
       </ng-template>
      </p-table>
     </div>

    <!-- BOTONES -->
    <div class="mb-3">
      <div class="d-grid gap-2 d-md-flex justify-content-md-center">
        <button pButton class="p-button-danger" id="agregar" type="button" label="Añadir Desperdicio" [disabled]="ordenesTrabajo.length == 0" icon="pi pi-send" (click)="generarDesperdicio()"></button>
        <button pButton class="p-button-secondary" id="limpiarCampos" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="limpiarCampos()"> </button>
        <!-- <button pButton class="p-button-success" id="bascula" type="button" label="Conectar Bascula" icon="pi pi-power-off" (click)="getPuertoSerial()"></button> -->
      </div>
    </div>
  </form>

  <!--Linea-->
  <div class="mb-4">
    <hr class="colorLinea">
  </div>

   <!--Desperdicio Actual-->
  <div class="mb-4">
   <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-wrench"></i> Información de Desperdicio Actual</h4>
  </div>

  <!--TABLA DE DESPERDICIO-->
  <div class="row g-3">
    <div class="table-responsive" id="tabla">
      <p-table
        *ngIf="!cargando"
        #dt2
        [resizableColumns]="true"
        columnResizeMode="expand"
        styleClass="p-datatable-sm"
        responsiveLayout="scroll"
        [paginator]="true"
        [rows]="20"
        [rowHover]="true"
        [value]="desperdicios"
        [scrollable]="true"
        scrollHeight="50rem">
        <ng-template pTemplate="header">
          <tr>
            <th></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'rollo', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'maquina', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'material', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'operario', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'noConformidad', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'peso', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'impreso', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'fecha', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'hora', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'proceso', 'contains')"></th>
            <th><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, 'observacion', 'contains')"></th>
          </tr>
          <tr>
            <th class="text-center" scope="col">#</th>
            <th class="text-center" scope="col">Rollo</th>
            <th class="text-center" scope="col">Maquina</th>
            <th class="text-center" scope="col">Material</th>
            <th class="text-center" scope="col">Operario</th>
            <th class="text-center" scope="col">No Conformidad</th>
            <th class="text-center" scope="col">Cantidad Kg</th>
            <th class="text-center" scope="col">Impreso</th>
            <th class="text-center" scope="col">Fecha</th>
            <th class="text-center" scope="col">Hora</th>
            <th class="text-center" scope="col">Proceso</th>
            <th class="text-center" scope="col">Observacion</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-desperdicio let-rowIndex="rowIndex">
          <tr>
            <td class="text-center">{{rowIndex + 1}}</td>
            <td class="text-center">{{desperdicio.rollo}}</td>
            <td class="text-center">{{desperdicio.maquina}}</td>
            <td class="text-center"><b>{{desperdicio.material}}</b></td>
            <td class="text-center">{{desperdicio.operario}}</td>
            <td class="text-center">{{desperdicio.noConformidad}}</td>
            <td class="text-center"><b>{{desperdicio.peso | number : '1.2-2' }}</b></td>
            <td class="text-center">{{desperdicio.impreso}}</td>
            <td class="text-center">{{desperdicio.fecha | date : 'yyyy-MM-dd' }}</td>
            <td class="text-center">{{desperdicio.hora}}</td>
            <td class="text-center"><b>{{desperdicio.proceso == 'DESP_CORTADORES' ? 'CORTE' : desperdicio.proceso.replace('DESP_', '')}}</b></td>
            <td class="text-center">{{desperdicio.observacion}}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="12"><h6 class="bold">No existen registros de Desperdicio.</h6></td>
          </tr>
        </ng-template>  
        <ng-template pTemplate="footer">
          <tr id="totales">
            <td colspan="6" class="text-right">Totales</td>
            <td class="text-center">{{desperdicios.length > 0 ? calcularPeso().toFixed(2) : 0 | number : '1.2-2'}} Kg</td>
            <td colspan="5" class="text-center"></td>
          </tr>
        </ng-template>  
      </p-table>
    </div>
  </div>
</p-card>