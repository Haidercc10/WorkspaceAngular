<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"> Movimientos de Despacho</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="mb-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-filter"></i> Filtros de búsqueda</h4>
  </div>

  <form [formGroup]="formSearchDespacho" (ngSubmit)="searchMovements()">
    <div class="row g-4 my-3">
      <!-- DATE START -->
      <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <p-calendar formControlName="dateStart" inputId="FechaInicial" [showIcon]="true"></p-calendar>
          <label for="FechaInicial">Fecha Inicial</label>
        </span>
      </div>

      <!-- DATE END -->
      <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-float-label">
          <p-calendar formControlName="dateEnd" inputId="FechaInicial" [showIcon]="true"></p-calendar>
          <label for="FechaInicial">Fecha Fin</label>
        </span>
      </div>

      <!-- DOCUMENT -->
      <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="document" id="document" type="text" pInputText/>
          <label for="document">Cod. Documento</label>
        </span>
      </div>

      <!-- DRIVER -->
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
        <span class="p-float-label">
          <p-dropdown formControlName="driver" inputId="production" [autoDisplayFirst]="false" [options]="drivers" optionLabel="nombre" optionValue="id" [required]="true" [filter]="true" filterBy="nombre"></p-dropdown>
          <label for="operario">Conductores</label>
        </span>
      </div>

      <!-- ID CAR -->
      <div class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-xxl-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="car" id="document" type="text" pInputText/>
          <label for="document">Placa Camión</label>
        </span>
      </div>
    </div>

    <div class="mb-3">
      <div class="d-grid gap-2 d-md-flex justify-content-md-center">
        <button pButton class="p-button-danger" id="consultar" type="submit" label="Consultar" icon="pi pi-check"></button>
        <button pButton class="p-button-secondary" id="limpiar" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearFields()"> </button>
      </div>
    </div>
  </form>

  <p-divider></p-divider>

  <div class="mb-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-list"></i> Registros consultados</h4>
  </div>

  <p-table [value]="dataDespacho" dataKey="factura" [tableStyle]="{ 'min-width': '60rem' }">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 5rem"></th>
        <th scope="col">Factura <p-sortIcon field="factura" id="sort"></p-sortIcon></th>
        <th scope="col">Cliente <p-sortIcon field="cliente"></p-sortIcon></th>
        <th scope="col">Conductor <p-sortIcon field="conductor"></p-sortIcon></th>
        <th scope="col">Placa Camión <p-sortIcon field="placa"></p-sortIcon></th>
        <th scope="col">Peso Neto <p-sortIcon field="PesoTotal"></p-sortIcon></th>
        <th scope="col">Fecha <p-sortIcon field="fecha"></p-sortIcon></th>
        <th scope="col">Hora <p-sortIcon field="hora"></p-sortIcon></th>
        <th scope="col">Ver</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-expanded="expanded">
      <tr>
        <td>
          <button type="button" pButton pRipple [pRowToggler]="data" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
        </td>
        <td>{{data.factura}}</td>
        <td>{{data.cliente}}</td>
        <td>{{data.conductor}}</td>
        <td>{{data.placa}}</td>
        <td>{{data.pesoTotal | number : '1.2-2'}}</td>
        <td>{{data.fecha | date : 'yyyy-MM-dd'}}</td>
        <td>{{data.hora}}</td>
        <td>
          <button pButton type="button" id="pdf" style="width: 30px; height: 30px;" class="p-button-danger p-button-rounded" pTooltip="PDF" icon="pi pi-file-pdf" (click)="createPDF(data)"></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-data>
      <tr>
        <td colspan="10">
          <div class="p-3">
            <p-table [value]="data.details" dataKey="id">
              <ng-template pTemplate="header">
                <tr>
                  <th scope="col">Item <p-sortIcon field="item"></p-sortIcon></th>
                  <th scope="col">Referencia <p-sortIcon field="referencia"></p-sortIcon></th>
                  <th scope="col">Rollo <p-sortIcon field="rollo"></p-sortIcon></th>
                  <th scope="col">Peso Neto <p-sortIcon field="peso"></p-sortIcon></th>
                  <th scope="col">Cantidad <p-sortIcon field="cantidad"></p-sortIcon></th>
                  <th scope="col">Presentación <p-sortIcon field="presentacion"></p-sortIcon></th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-product>
                <tr>
                  <td>{{product.item}}</td>
                  <td>{{product.referencia}}</td>
                  <td>{{product.rollo}}</td>
                  <td>{{product.peso | number : '1.2-2'}}</td>
                  <td>{{product.cantidad | number : '1.2-2'}}</td>
                  <td>{{product.presentacion}}</td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="6">No hay rollos para esta factura.</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

</p-card>