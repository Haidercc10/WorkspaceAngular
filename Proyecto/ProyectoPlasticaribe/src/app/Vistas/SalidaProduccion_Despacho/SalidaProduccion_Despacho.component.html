<div class="d-flex justify-content-center overlay" *ngIf="load">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <!-- Navegador fin de parte superior -->
  <div class="container-fluid">
    <div class="mb-4 Titulo">
      <h2 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }">Despacho de Mercancia</h2>
    </div>
    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<p-card>
  <div class="mb-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-wrench"></i> Cargar Datos Producción</h4>
  </div>

  <form [formGroup]="formProduction">
    <div class="row g-4 my-5">

      <div class="col-sm-12 col-md-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="preload" type="number" id="preload" pInputText (keyup.enter)="getInformationPreload()"/>
          <label for="preload">N° Precargue</label>
        </span>
      </div>

      <div class="col-sm-12 col-md-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="orderFact" type="number" id="orderFact" required pInputText (keyup.enter)="getInformationOrderFact()"/>
          <label for="orderFact">Orden Fact.</label>
        </span>
      </div>

      <div class="col-sm-12 col-md-2">
        <span class="p-input-icon-left p-float-label">
          <i class="pi pi-search"></i>
          <input formControlName="production" id="RolloBarCode" type="number" class="read-only" pInputText pAutoFocus autocomplete="off" [autofocus]="true" (keyup)="quitBarCode()" (keyup.enter)="getInformationProduction()"/>
          <label for="RolloBarCode">Rollo Leído</label>
        </span>
      </div>

       <div class="col-sm-12 col-md-2">
        <span class="p-float-label">
          <input formControlName="fact" type="text" id="fact" pInputText [required]="true" readonly/>
          <label for="fact">Factura</label>
        </span>
      </div>

      <div class="col-sm-12 col-md-2">
        <span class="p-float-label">
          <p-dropdown formControlName="driver" inputId="production" [autoDisplayFirst]="false" [options]="drivers" optionLabel="nombre" optionValue="id" [required]="true" [filter]="true" filterBy="nombre"></p-dropdown>
          <label for="operario">Conductores</label>
        </span>
      </div>

      <div class="col-sm-12 col-md-2">
        <span class="p-float-label">
          <input formControlName="car" type="text" id="car" pInputText required/>
          <label for="car">Placa Carro</label>
        </span>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 col-xxl-12">
        <span class="p-float-label">
          <textarea formControlName="observation" [rows]="1"  maxlength="200" pInputTextarea></textarea>
          <label for="textarea">Observación</label>
        </span>
      </div>
    </div>
  </form>

  <p-table
    *ngIf="!load"
    [value]="sendProductionZeus"
    columnResizeMode="expand"
    styleClass="p-datatable-sm"
    responsiveLayout="scroll"
    [rowHover]="true"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} rollos"
    [scrollable]="true"
    scrollHeight="50rem">
    <ng-template pTemplate="header">
      <tr>
        <th class="text-center">#</th>
        <th class="text-center">OT</th>
        <th class="text-center">Cliente</th>
        <th class="text-center">Rollo</th>
        <th class="text-center">Item</th>
        <th class="text-center">Referencia</th>
        <th class="text-center">Peso Bruto</th>
        <th class="text-center">Peso Neto</th>
        <th class="text-center">Presentación</th>
        <th class="text-center">Fecha</th>
        <th class="text-center">Hora</th>
        <th class="text-center">Proceso</th>
        <!--<th class="text-center">Pallet</th>-->
        <!--<th class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">Imprimir</th>-->
        <th class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">Quitar</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td class="text-center">{{data.position == 0 ? rowIndex + 1 : data.position}}</td>
        <td class="text-center">{{data.pp.ot}}</td>
        <td class="text-center">{{data.clientes.cli_Nombre}}</td>
        <td class="text-center">{{data.dataExtrusion.numero_RolloBagPro}}</td>
        <td class="text-center">{{data.producto.prod_Id}}</td>
        <td class="text-center">{{data.producto.prod_Nombre}}</td>
        <td class="text-center">{{(['Und', 'Paquete'].includes(data.pp.presentacion) ? data.pp.cantidad : data.pp.peso_Bruto) | number : '1.2-2'}}</td>
        <td class="text-center">{{data.pp.peso_Neto | number : '1.2-2'}}</td>
        <td class="text-center">{{data.pp.presentacion}}</td>
        <td class="text-center">{{data.pp.fecha | date : 'YYYY-MM-dd'}}</td>
        <td class="text-center">{{data.pp.hora}}</td>
        <td class="text-center">{{data.proceso.proceso_Nombre | uppercase}}</td>
        <!--<td class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">
          <p-button icon="pi pi-print" [rounded]="true" severity="success" (onClick)="printTag(data)"></p-button>-->
          <!--{{data.pallet}}-->
        <!--</td>-->
        <td class="text-center" alignFrozen="right" pFrozenColumn [frozen]="true">
          <p-button icon="pi pi-trash" [rounded]="true" severity="danger" (onClick)="removeProduction(data)"></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td class="text-right" colspan="6">Totales</td>
        <td class="text-center">{{totalQuantity() | number : '1.2-2'}}</td>
        <td class="text-center">{{totalWeight() | number : '1.2-2'}}</td>
        <td colspan="5"></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="d-grid gap-2 d-md-flex justify-content-md-center my-2">
    <button pButton class="p-button-danger" id="crear" type="button" label="Despachar Mercancia" icon="pi pi-send" [disabled]="formProduction.invalid" (click)="validateDataToSave()"></button>
    <button pButton class="p-button-secondary" id="limpiar" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="clearFields()"></button>
  </div>
</p-card>

<!-- Modal de rollos no leídos -->
<p-dialog [(visible)]="modalProductionNotRead" [draggable]="false" [style]="{width: '80%'}" header="Rollos/Bultos no leidos o encontrados" [modal]="true">
  <div class="my-4">
    <h4 [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-exclamation-triangle"></i> Los siguientes rollos pertenecen a la orden de facturación pero no fueron leidos al registrar el despacho, por favor ingreselos para poder continuar.</h4>
  </div>

  <p-table
    [value]="remainingProduction"
    styleClass="p-datatable-gridlines p-datatable-sm"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="30rem"
    dataKey="numberProduction"
    *ngIf="!load">
    <ng-template pTemplate="header">
      <tr>
        <th>#</th>
        <th>Numero Rollo</th>
        <th>Item</th>
        <th>Referencia</th>
        <th>Cantidad</th>
        <th>Presentación</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
      <tr>
        <td>{{rowIndex + 1}}</td>
        <td>{{data.numberProduction}}</td>
        <td>{{data.item}}</td>
        <td>{{data.reference}}</td>
        <td>{{data.quantity | number : '1.2-2'}}</td>
        <td>{{data.presentation}}</td>
      </tr>
    </ng-template>
  </p-table>

</p-dialog>

<!-- Modal de rollos que no están en un pallet -->
<p-dialog [(visible)]="modalProductionOutPallet" [draggable]="false" [style]="{width: '60%'}" [modal]="true">
  <div class="my-4">
    <div class="mb-4">
      <h4 class="text-center" [ngClass]="{'tituloRojo' : !modoSeleccionado, 'tituloClaro': modoSeleccionado }"><i class="pi pi-exclamation-triangle"></i> <b> Nota:</b> Los siguientes rollos pertenecen al pallet leído <b>pero no están disponibles, debe ingresarlos para continuar.</b></h4>
    </div>
    <p-table
      [value]="productionOutPallet"
      styleClass="p-datatable-gridlines p-datatable-sm"
      responsiveLayout="scroll"
      [scrollable]="true"
      scrollHeight="30rem"
      dataKey="numberProduction"
      *ngIf="!load">
      <ng-template pTemplate="header">
        <tr>
          <th>#</th>
          <th>Numero Rollo</th>
          <th>Item</th>
          <th>Referencia</th>
          <th>Cantidad</th>
          <th>Presentación</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">
        <tr>
          <td>{{rowIndex + 1}}</td>
          <td>{{data.numberProduction}}</td>
          <td>{{data.item}}</td>
          <td>{{data.reference}}</td>
          <td>{{data.quantity | number : '1.2-2'}}</td>
          <td>{{data.presentation}}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>
