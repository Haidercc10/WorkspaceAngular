<app-menuLateral></app-menuLateral>

<p-toast position="center" [preventOpenDuplicates]="true"></p-toast>

<div class="d-flex justify-content-center overlay" *ngIf="cargando">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="contain">
  <!-- Navegador fin de parte superior -->
  <div class="container-fluid">
    <!-- principal -->
    <div class="mb-4 Titulo">
      <h2 class="tituloRojo">Pedidos de Productos</h2>
    </div>

    <div class="mb-4">
      <hr class="colorLinea">
    </div>
  </div>
</div>

<div class="formulario">

  <!-- Informacion sobre los colores -->
  <p-toolbar>
    <ng-template pTemplate="right">
      <p-button icon="pi pi-info-circle" class="mr-2" styleClass="p-button-rounded p-button-success" (click)="mostrarDescripcion($event, 'verde')"></p-button>
      <p-button icon="pi pi-info-circle" class="mr-2" styleClass="p-button-rounded p-button-info" (click)="mostrarDescripcion($event, 'azul')"></p-button>
      <p-button icon="pi pi-info-circle" class="mr-2" styleClass="p-button-rounded p-button-danger" (click)="mostrarDescripcion($event, 'rojo')"></p-button>
    </ng-template>

    <ng-template pTemplate="left">
      <h6>¡Si deseas saber que indica cada color, presiona el botón con el color que quieres conocer!</h6>
    </ng-template>
  </p-toolbar>

  <!-- Exportar a excel -->
  <p-toolbar>
    <ng-template pTemplate="right">
      <button pButton pRipple label="Exportar Excel" icon="pi pi-file-excel" class="p-button-success r-2" (click)="exportarExcel()"></button>
    </ng-template>

    <ng-template pTemplate="left">
      <h3 class="tituloRojo"><i class="pi pi-info-circle"></i> Información de Pedidos</h3>
    </ng-template>
  </p-toolbar>
  <br>

  <div class="row g-2 p-2">
    <p-table
      #dt
      [columns]="columnasSeleccionadas"
      [value]="ArrayPedidos"
      rowGroupMode="subheader"
      groupRowsBy="consecutivo"
      [resizableColumns]="true"
      [reorderableColumns]="true"
      columnResizeMode="expand"
      styleClass="p-datatable-gridlines p-datatable-sm"
      responsiveLayout="scroll"
      [rowHover]="true"
      dataKey="id"
      [scrollable]="true"
      scrollHeight="50rem"
      *ngIf="!cargando"
      [expandedRowKeys]="expandedRows"
      sortField="id_color"
      [sortOrder]="1">
      <!-- Buscador de columnas -->
      <ng-template pTemplate="caption">
        <p-multiSelect
          [options]="columnas"
          [(ngModel)]="columnasSeleccionadas"
          optionLabel="header"
          selectedItemsLabel="{0} columnas seleccionadas"
          [style]="{minWidth: '330px'}"
          placeholder="Elige las columnas que quieres ver"></p-multiSelect>
      </ng-template>
      <!-- Filtros y Titulos -->
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th *ngFor="let col of columns"><input pInputText type="{{col.type}}" style="width: 100%;" (input)="aplicarfiltro($event, col.field, 'contains')"></th>
          <th style="width: 100px"><input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')"></th>
          <th style="width: 100px"><input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')"></th>
          <th style="width: 100px" *ngIf="ValidarRol == 1"><input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')"></th>
          <th style="width: 100px" *ngIf="ValidarRol == 1"><input pInputText type="text" style="width: 100%;" (input)="aplicarfiltro($event, 'consecutivo', 'contains')"></th>
        </tr>
        <tr>
          <th *ngFor="let col of columnasSeleccionadas" class="text-center" pResizableColumn pReorderableColumn pSortableColumn="{{col.field}}">{{col.header}}
            <p-sortIcon [field]="col.field"></p-sortIcon>
          </th>
          <th style="text-align: center;" class="font-size-14" pResizableColumn>Ver PDF</th>
          <th style="text-align: center;" class="font-size-14" pResizableColumn>Editar</th>
          <th style="text-align: center;" class="font-size-14" *ngIf="ValidarRol == 1" pResizableColumn>Aceptar</th>
          <th style="text-align: center;" class="font-size-14" *ngIf="ValidarRol == 1" pResizableColumn>Anular / Cancelar</th>
        </tr>
      </ng-template>
      <!-- Titulo de Agrupacion -->
      <ng-template pTemplate="groupheader" let-pedido let-rowIndex="rowIndex" let-expanded="expanded">
        <tr>
          <td [attr.colspan]="columnasSeleccionadas.length" class="font-size-16" [ngClass]="{'verde' : pedido.color == 'verde', 'azul' : pedido.color == 'azul', 'rojo' : pedido.color == 'rojo', 'blanco' : pedido.color == 'blanco'}">
            <button type="button" pButton pRipple [pRowToggler]="pedido" class="p-button-text p-button-rounded p-button-plain mr-2" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
            <span class="font-bold">
              {{pedido.consecutivo}}
            </span>
            <span class="font-bold"> {{pedido.cliente}} </span>
          </td>
          <td style="text-align: center;" scope="col" title="Ver detalle del pedido"><button pButton pRipple icon="pi pi-eye" class="p-button-rounded p-button-success mr-2" style="width: 30px; height: 30px;"></button></td>
          <td style="text-align: center;" scope="col" title="Editar Pedido"><button [disabled]="pedido.color != 'rojo'" pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-info mr-2" data-bs-toggle="modal" data-bs-target="#staticBackdrop2" style="width: 30px; height: 30px;"></button></td>
          <td style="text-align: center;" scope="col" title="Confirmar Pedido" *ngIf="ValidarRol == 1"><button  [disabled]="pedido.color != 'rojo'" pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-success mr-2" style="width: 30px; height: 30px;"></button></td>
          <td style="text-align: center;" scope="col" title="Confirmar Pedido" *ngIf="ValidarRol == 1"><button  [disabled]="pedido.color != 'rojo'" pButton pRipple icon="pi pi-times" class="p-button-rounded p-button-danger mr-2" style="width: 30px; height: 30px;"></button></td>
        </tr>
      </ng-template>
      <!-- Footer de los agrupado -->
      <ng-template pTemplate="groupfooter" let-pedidos>
        <tr class="p-rowgroup-footer">
          <td style="text-align: left">Total Pendiente Pedido</td>
          <td [attr.colspan]="columnasSeleccionadas.length + 3">{{calcularCostoPedido(pedidos.consecutivo) | currency : 'COP $'}}</td>
        </tr>
      </ng-template>
      <!-- Cuerpo con informacion dellada -->
      <ng-template pTemplate="rowexpansion" let-pedidos let-columns="columns">
        <tr>
          <td *ngFor="let col of columns" [ngClass]="{'verde' : pedidos.color == 'verde' || (pedidos.color == 'verde'), 'azul' : pedidos.color == 'azul', 'rojo' : pedidos.color == 'rojo', 'blanco' : pedidos.color == 'blanco'}">
            <span [ngClass]="{
            'badge verde3': (col.field === 'OT' || col.field === 'Proceso_OT') && pedidos.Estado_OT === 17,
            'badge verde2': col.field === 'OT' && pedidos.Estado_OT === 18,
            'badge rojo' : col.field === 'OT' && pedidos.Estado_OT === 3,
            'badge azul': col.field === 'OT' && pedidos.Estado_OT === 14,
            'badge amarillo': (col.field === 'OT' || col.field === 'Proceso_OT') && pedidos.Estado_OT === 16,
            'badge naranja' : col.field === 'OT' && pedidos.Estado_OT === 15,
            'badge bg-danger1' : col.field === 'estado' && pedidos.estado === 'Pendiente',
            'badge bg-warning1' : col.field === 'estado' && pedidos.estado === 'Parcialmente Satisfecho',
            'negrita font-size-16' : pedidos.producto == '' }">{{col.tipo == 'numero' ? (pedidos[col.field] | number : '1.2-2') : (pedidos[col.field])}}</span>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>


<p-overlayPanel #op [style]="{background: 'rgba(0, 3, 34, 0.9)', width: '350px', color : 'rgb(247, 247, 247)' }" >
  <ng-template #infoColor>
    {{infoColor}}
  </ng-template>
</p-overlayPanel>
