<div class="d-flex justify-content-center overlay" *ngIf="cargando">
  <div style="margin: auto;">
    <p-progressSpinner></p-progressSpinner>
  </div>
</div>

<div class="mb-4">
  <h4 class="tituloRojo"><i class="pi pi-search"></i> Filtros de Busqueda</h4>
  <br>
</div>

<form [formGroup]="formFiltros" (ngSubmit)="consultarOrdenes()">
  <div class="row g-4 mb-2">
      <!-- BUSCAR POR -->
    <div class="col-sm-12 col-md-6 col-xl-2 text-center">
      <p-radioButton formControlName="buscarPorItem_Ot" name="buscarPorItem_Ot" value="Item" [required]="true"></p-radioButton>
      <label class="mx-2" for="item">Item</label>

      <p-radioButton formControlName="buscarPorItem_Ot" name="buscarPorItem_Ot" value="OT" [required]="true"></p-radioButton>
      <label class="mx-2" for="ot">OT</label>
    </div>

    <!-- RANGO DE FECHAS -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label" id="rango-fechas">
        <p-calendar formControlName="rangoFechas" inputId="fechas" selectionMode="range" [showIcon]="true" pTooltip="Selecciona el rango de fechas en el que deseas consultar"></p-calendar>
        <label for="fechas">Rango de Fechas</label>
      </span>
    </div>

    <!-- ID CLIENTE -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-input-icon-left p-float-label">
        <i class="pi pi-user"></i>
        <input formControlName="idCliente" type="text" id="orden" pInputText [readonly]="true"/>
        <label for="orden">Id Cliente</label>
      </span>
    </div>

    <!-- CLIENTE -->
    <div class="col-sm-12 col-md-6 col-xl-4">
      <span class="p-input-icon-left p-float-label">
        <i class="pi pi-users"></i>
        <input formControlName="cliente" id="cliente" list="clientesConsultados" type="text" pInputText (keyup)="consultarClientes()" (change)="clienteSeleccionado()" autocomplete="off"/>
        <datalist id="clientesConsultados">
          <option value={{item.sedeCli_CodBagPro}} *ngFor="let item of clientes">{{item.cli_Nombre}}</option>
        </datalist>
        <label for="cliente">Cliente</label>
      </span>
    </div>

    <!-- ITEM -->
    <div class="col-sm-12 col-md-6 col-xl-2">
      <span class="p-input-icon-left p-float-label">
        <i class="pi pi-box"></i>
        <input formControlName="item" type="text" id="item" pInputText/>
        <label for="item">Item</label>
      </span>
    </div>

    <!-- REFERENCIA -->
    <div class="col-sm-12 col-md-6 col-xl-4">
      <span class="p-input-icon-left p-float-label">
        <i class="pi pi-th-large"></i>
        <input formControlName="referencia" id="referencias" list="productosConsultados" type="text" pInputText (keyup)="consultarProductos()" (change)="productoSeleccionado()" autocomplete="off"/>
        <datalist id="productosConsultados">
          <option value={{item.prod_Id}} *ngFor="let item of productos">{{item.prod_Nombre}}</option>
        </datalist>
        <label for="referencias">Referencia</label>
      </span>
    </div>

    <!-- MATERIAL -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label">
        <p-dropdown formControlName="material" inputId="Material" optionValue="material_Nombre" [autoDisplayFirst]="false" [options]="materiales" optionLabel="material_Nombre"></p-dropdown>
        <label for="Material">Material</label>
      </span>
    </div>

    <!-- PIGMENTO -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label">
        <p-dropdown formControlName="pigmento" inputId="Pigmento" optionValue="pigmt_Nombre" [autoDisplayFirst]="false" [options]="pigmentos" optionLabel="pigmt_Nombre"></p-dropdown>
        <label for="Pigmento">Pigmento</label>
      </span>
    </div>

    <!-- ANCHO -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label">
        <p-inputNumber formControlName="ancho" inputId="anchoItem" mode="decimal" [minFractionDigits]="2"></p-inputNumber>
        <label for="anchoItem">Ancho</label>
      </span>
    </div>

    <!-- LARGO -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label">
        <p-inputNumber formControlName="largo" inputId="largoItem" mode="decimal" [minFractionDigits]="2"></p-inputNumber>
        <label for="largoItem">Largo</label>
      </span>
    </div>

    <!-- FUELLE -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label">
        <p-inputNumber formControlName="fuelle" inputId="fuelleItem" mode="decimal" [minFractionDigits]="2"></p-inputNumber>
        <label for="fuelleItem">Fuelle</label>
      </span>
    </div>

    <!-- CALIBRE -->
    <div class="col-sm-12 col-md-6 col-xl-3">
      <span class="p-float-label">
        <p-inputNumber formControlName="calibre" inputId="calibreItem" mode="decimal" [minFractionDigits]="2"></p-inputNumber>
        <label for="calibreItem">Calibre</label>
      </span>
    </div>
  </div>

  <div class="row my-5">
    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
      <button pButton class="p-button-danger" id="crear" type="submit" label="Consultar" icon="pi pi-check"></button>
      <button pButton class="p-button-secondary" id="limpiar" type="button" label="Limpiar Campos" icon="pi pi-eraser" (click)="limpiarCampos()"></button>
    </div>
  </div>
</form>

<p-table
  #dt
  [columns]="columnasSeleccionadas"
  [value]="ordenesConsultadas"
  [resizableColumns]="true"
  [reorderableColumns]="true"
  columnResizeMode="expand"
  styleClass="p-datatable-gridlines p-datatable-sm"
  responsiveLayout="scroll"
  [rowHover]="true"
  dataKey="id"
  [scrollable]="true"
  scrollHeight="50rem"
  [showCurrentPageReport]="true"
  currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros"
  [paginator]="true"
  [rows]="20"
  [rowsPerPageOptions]="[10, 20, 50, 100, ordenesConsultadas.length]">
  <ng-template pTemplate="caption">
    <p-multiSelect
      [options]="columnas"
      [(ngModel)]="columnasSeleccionadas"
      optionLabel="header"
      selectedItemsLabel="{0} columnas seleccionadas"
      [style]="{minWidth: '330px'}"
      placeholder="Elige las columnas que quieres ver"
      id="columnas"></p-multiSelect>
  </ng-template>
  <ng-template pTemplate="header" let-columns>
    <tr>
      <th *ngFor="let col of columns"><input pInputText style="width: 100%;" (input)="aplicarfiltro($event, col.field)"></th>
    </tr>
    <tr>
      <th *ngFor="let col of columnasSeleccionadas" class="text-center" pResizableColumn pReorderableColumn pSortableColumn="{{col.field}}">{{col.header}}
        <p-sortIcon [field]="col.field"></p-sortIcon>
      </th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-data let-columns="columns">
    <tr (dblclick)="crearOrdenTrabajo(data)" class="no-seleccionable cursor">
      <td *ngFor="let col of columns">{{col.tipo == 'number' ? (data[col.field] | number : '1.2-2') : col.tipo == 'date' ? (data[col.field] | date : 'YYYY-MM-dd') : (data[col.field])}}</td>
    </tr>
  </ng-template>
</p-table>